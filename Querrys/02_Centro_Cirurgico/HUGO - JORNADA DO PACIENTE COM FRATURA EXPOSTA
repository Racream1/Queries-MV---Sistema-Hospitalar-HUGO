-- =================================================================
-- PORTLET: EVOLUCOES MEDICAS COM "FRATURA EXPOSTA" (ÚLTIMOS 7 DIAS)
-- Descrição: Busca APENAS evoluções médicas (TP_PRE_MED = 'M')
--            de pacientes internados nos últimos 7 dias (e ainda internados)
--            que contenham os termos "Fratura Exposta" ou "Fx Exposta".
-- CORREÇÃO: Utiliza fnc_extrair_coluna_long para pesquisar no campo LONG
-- =================================================================

SELECT 
    TO_CHAR(A.CD_ATENDIMENTO) AS COD_ATENDIMENTO,
    TO_CHAR(P.CD_PACIENTE) AS COD_PACIENTE,
    P.NM_PACIENTE AS NOME_PACIENTE,
    TO_CHAR(PM.DT_PRE_MED, 'DD/MM/YYYY') AS DATA_EVOLUCAO,
    TO_CHAR(PM.HR_PRE_MED, 'HH24:MI') AS HORA_EVOLUCAO,
    
    -- CORREÇÃO: É necessário usar a função também no SELECT para exibir o campo LONG
    fnc_extrair_coluna_long('ds_evolucao', 'pre_med', 'cd_pre_med', PM.cd_pre_med) AS TEXTO_EVOLUCAO,
    
    TO_CHAR(PR.CD_PRESTADOR) AS COD_MEDICO,
    PR.NM_PRESTADOR AS NOME_MEDICO,
    E.DS_ESPECIALID AS ESPECIALIDADE,
    UI.DS_UNID_INT AS UNIDADE_INTERNACAO,
    L.DS_LEITO AS LEITO,
    S.NM_SETOR AS SETOR,
    'Medica' AS TIPO_PRESCRICAO,
    CASE PM.SN_FECHADO
        WHEN 'S' THEN 'Fechada'
        WHEN 'N' THEN 'Aberta'
        ELSE 'Nao Informado'
    END AS STATUS_PRESCRICAO,
    PM.NM_USUARIO AS USUARIO_REGISTRO,
    TO_CHAR(A.HR_ATENDIMENTO, 'DD/MM/YYYY HH24:MI') AS DATA_INTERNACAO,
    CASE A.TP_ATENDIMENTO
        WHEN 'I' THEN 'Internacao'
        WHEN 'U' THEN 'Urgencia'
        WHEN 'A' THEN 'Ambulatorial'
        WHEN 'E' THEN 'Externo'
        ELSE 'Outros'
    END AS TIPO_ATENDIMENTO
FROM 
    DBAMV.PRE_MED PM
    INNER JOIN DBAMV.ATENDIME A ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
    INNER JOIN DBAMV.PACIENTE P ON A.CD_PACIENTE = P.CD_PACIENTE
    LEFT JOIN DBAMV.PRESTADOR PR ON PM.CD_PRESTADOR = PR.CD_PRESTADOR
    LEFT JOIN DBAMV.ESP_MED EM ON PR.CD_PRESTADOR = EM.CD_PRESTADOR 
        AND EM.SN_ESPECIAL_PRINCIPAL = 'S'
    LEFT JOIN DBAMV.ESPECIALID E ON EM.CD_ESPECIALID = E.CD_ESPECIALID
    LEFT JOIN DBAMV.LEITO L ON A.CD_LEITO = L.CD_LEITO
    LEFT JOIN DBAMV.UNID_INT UI ON L.CD_UNID_INT = UI.CD_UNID_INT
    LEFT JOIN DBAMV.SETOR S ON PM.CD_SETOR = S.CD_SETOR
WHERE 
    -- Filtro: APENAS evoluções médicas
    PM.TP_PRE_MED = 'M'
    
    -- Filtros básicos
    AND A.CD_MULTI_EMPRESA = 40
    AND PM.DS_EVOLUCAO IS NOT NULL
    
    -- NOVOS FILTROS (Requisito do Usuário)
    
    -- 1. Filtro de Data: Pacientes internados nos últimos 7 dias E ainda internados
    AND A.DT_ALTA IS NULL
    AND A.HR_ATENDIMENTO >= TRUNC(SYSDATE) - 7
    
    -- 2. Filtro de Conteúdo (CORRIGIDO)
    -- Aplicar a função fnc_extrair_coluna_long antes de INSTR e UPPER
    AND (
        INSTR(UPPER(fnc_extrair_coluna_long('ds_evolucao', 'pre_med', 'cd_pre_med', PM.cd_pre_med)), 'FRATURA EXPOSTA') > 0
        OR INSTR(UPPER(fnc_extrair_coluna_long('ds_evolucao', 'pre_med', 'cd_pre_med', PM.cd_pre_med)), 'FX EXPOSTA') > 0
    )
    
ORDER BY 
    PM.DT_PRE_MED DESC,
    PM.HR_PRE_MED DESC,
    P.NM_PACIENTE
