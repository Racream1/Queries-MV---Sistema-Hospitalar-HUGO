SELECT
    A.CD_ATENDIMENTO,
    PAC.NM_PACIENTE,
    A.DT_ATENDIMENTO AS DATA_INTERNACAO,
    A.DT_ALTA AS DATA_ALTA,
    A.CD_PROCEDIMENTO AS CD_PROCEDIMENTO_SIGTAP,
    SUS.DS_PROCEDIMENTO,
    CASE
        WHEN A.CD_PROCEDIMENTO LIKE '03%' THEN 'Clínico'
        WHEN A.CD_PROCEDIMENTO LIKE '04%' THEN 'Cirúrgico'
        ELSE 'Outro'
    END AS TIPO_PROCEDIMENTO
FROM
    DBAMV.ATENDIME A
INNER JOIN
    DBAMV.PROCEDIMENTO_SUS SUS ON SUS.CD_PROCEDIMENTO = A.CD_PROCEDIMENTO
LEFT JOIN
    DBAMV.PACIENTE PAC ON A.CD_PACIENTE = PAC.CD_PACIENTE
WHERE
    A.CD_MULTI_EMPRESA = 40
    AND A.TP_ATENDIMENTO = 'I'
    AND A.DT_ALTA IS NOT NULL
    AND TRUNC(A.DT_ATENDIMENTO) = TRUNC(A.DT_ALTA)
    AND A.DT_ATENDIMENTO BETWEEN To_Date(Concat(To_Char($pgmvDataIni$,'dd/mm/yyyy'), '00:00:00'), 'dd/mm/yyyy hh24:mi:ss') 
                             AND To_Date(Concat(To_Char($pgmvDataFim$,'dd/mm/yyyy'), '23:59:59'), 'dd/mm/yyyy hh24:mi:ss')
    AND (
        (
            (A.CD_PROCEDIMENTO LIKE '0301%' AND A.CD_PROCEDIMENTO NOT LIKE '030101%')
            OR A.CD_PROCEDIMENTO LIKE '0303%'
            OR A.CD_PROCEDIMENTO LIKE '0308%'
        )
        OR
        (
            A.CD_PROCEDIMENTO LIKE '0401%' OR A.CD_PROCEDIMENTO LIKE '0404%'
            OR A.CD_PROCEDIMENTO LIKE '0405%' OR A.CD_PROCEDIMENTO LIKE '0407%'
            OR A.CD_PROCEDIMENTO LIKE '0408%' OR A.CD_PROCEDIMENTO LIKE '0409%'
            OR A.CD_PROCEDIMENTO LIKE '0415%' OR A.CD_PROCEDIMENTO LIKE '040305%'
        )
    )
ORDER BY
    A.DT_ATENDIMENTO DESC,
    PAC.NM_PACIENTE
