-- CTE 1: Base de dados com todos os avisos relevantes no período.
WITH BASE_AVISOS AS (
    SELECT
        AC.TP_SITUACAO,
        AC.CD_MOT_CANC_ATRASO,
        AC.CD_MOT_CANC,
        AC.CD_ATENDIMENTO,
        CA.CD_CIRURGIA,
        AC.CD_AVISO_CIRURGIA
    FROM
        AVISO_CIRURGIA AC
    INNER JOIN ATENDIME A ON AC.CD_ATENDIMENTO = A.CD_ATENDIMENTO
    LEFT JOIN CIRURGIA_AVISO CA ON AC.CD_AVISO_CIRURGIA = CA.CD_AVISO_CIRURGIA
    WHERE
        A.CD_MULTI_EMPRESA = 40
    AND AC.DT_AVISO_CIRURGIA BETWEEN $pgmvDataIni$ AND $pgmvDataFim$
),

-- CTE 2: Agrupa os avisos por jornada e adiciona flags de controle.
JORNADAS AS (
    SELECT
        CD_ATENDIMENTO,
        CD_CIRURGIA,
        COUNT(CD_AVISO_CIRURGIA) AS QTD_AVISOS_NA_JORNADA,
        -- Marca a jornada se ela tiver pelo menos um cancelamento
        MAX(CASE WHEN TP_SITUACAO = 'C' THEN 1 ELSE 0 END) AS FLAG_TEVE_CANCELAMENTO,
        -- !! NOVA FLAG: Marca a jornada se ela teve uma realização !!
        MAX(CASE WHEN TP_SITUACAO = 'R' THEN 1 ELSE 0 END) AS FLAG_FOI_REALIZADA
    FROM
        BASE_AVISOS
    WHERE CD_CIRURGIA IS NOT NULL
    GROUP BY
        CD_ATENDIMENTO,
        CD_CIRURGIA
),

-- CTE 3: Prepara os cálculos básicos para evitar repetição.
CALCULOS_BASE AS (
    SELECT
        (SELECT COUNT(*) FROM JORNADAS) AS TOTAL_JORNADAS,
        (SELECT SUM(FLAG_TEVE_CANCELAMENTO) FROM JORNADAS) AS QTD_JORNADAS_COM_CANCELAMENTO,
        (SELECT COUNT(*) FROM BASE_AVISOS) AS TOTAL_AVISOS,
        (SELECT SUM(CASE WHEN CD_MOT_CANC_ATRASO IS NOT NULL THEN 1 ELSE 0 END) FROM BASE_AVISOS) AS QTD_AVISOS_COM_ATRASO
    FROM DUAL
)

-- Query Final: Constrói a tabela de indicadores.
SELECT 'Total de Jornadas com Cancelamento' AS INDICADOR, TO_CHAR(QTD_JORNADAS_COM_CANCELAMENTO) AS VALOR FROM CALCULOS_BASE
UNION ALL
SELECT 'Percentual de Jornadas com Cancelamento' AS INDICADOR, CASE WHEN TOTAL_JORNADAS > 0 THEN TO_CHAR(ROUND(QTD_JORNADAS_COM_CANCELAMENTO * 100.0 / TOTAL_JORNADAS, 2), 'FM999999990.00') || ' %' ELSE '0.00 %' END FROM CALCULOS_BASE
UNION ALL
SELECT 'Total de Avisos com Atraso Registado' AS INDICADOR, TO_CHAR(QTD_AVISOS_COM_ATRASO) AS VALOR FROM CALCULOS_BASE
UNION ALL
SELECT 'Percentual de Avisos com Atraso' AS INDICADOR, CASE WHEN TOTAL_AVISOS > 0 THEN TO_CHAR(ROUND(QTD_AVISOS_COM_ATRASO * 100.0 / TOTAL_AVISOS, 2), 'FM999999990.00') || ' %' ELSE '0.00 %' END FROM CALCULOS_BASE
UNION ALL
-- !! NOVO INDICADOR: A MÉDIA GERAL QUE TU DESCREVESTE !!
SELECT
    'Média Geral de Avisos por Cirurgia Realizada' AS INDICADOR,
    TO_CHAR(
        (SELECT SUM(QTD_AVISOS_NA_JORNADA) FROM JORNADAS WHERE FLAG_FOI_REALIZADA = 1) / 
        (SELECT COUNT(*) FROM JORNADAS WHERE FLAG_FOI_REALIZADA = 1),
    'FM999999990.00') AS VALOR
FROM DUAL
UNION ALL
-- Indicador antigo, agora com nome mais específico
SELECT
    'Média de Avisos (APENAS em Jornadas c/ Cancelamento)' AS INDICADOR,
    TO_CHAR(ROUND(AVG(QTD_AVISOS_NA_JORNADA), 2), 'FM999999990.00') AS VALOR
FROM JORNADAS
WHERE FLAG_TEVE_CANCELAMENTO = 1
UNION ALL
SELECT
    'Principal Motivo de Cancelamento' AS INDICADOR,
    COALESCE(
        (SELECT DS_MOT_CANC FROM MOT_CANC WHERE CD_MOT_CANC = 
            (SELECT CD_MOT_CANC FROM BASE_AVISOS WHERE TP_SITUACAO = 'C' AND CD_MOT_CANC IS NOT NULL GROUP BY CD_MOT_CANC ORDER BY COUNT(*) DESC FETCH FIRST 1 ROW ONLY)
        ),
        'Nenhum cancelamento registado no período'
    ) AS VALOR
FROM DUAL
