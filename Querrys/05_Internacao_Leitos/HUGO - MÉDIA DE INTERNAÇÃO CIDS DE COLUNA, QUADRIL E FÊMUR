SELECT 
 TO_CHAR(a.DT_ATENDIMENTO, 'YYYY-MM') AS ORDEM,
 
 TO_CHAR(a.DT_ATENDIMENTO, 'MM/YYYY') AS MES,
 
 -- FRATURA DE COLUNA (cervical, toracica, lombar)
 COUNT(DISTINCT CASE 
 WHEN c.CD_CID LIKE 'S12%' OR c.CD_CID LIKE 'S22%' OR c.CD_CID LIKE 'S32%' 
 THEN a.CD_ATENDIMENTO 
 END) AS QTD_COLUNA,
 
 ROUND(AVG(CASE 
 WHEN c.CD_CID LIKE 'S12%' OR c.CD_CID LIKE 'S22%' OR c.CD_CID LIKE 'S32%' 
 THEN TRUNC(NVL(a.DT_ALTA, SYSDATE)) - TRUNC(a.DT_ATENDIMENTO)
 END), 1) AS MEDIA_COLUNA,
 
 -- FRATURA DE QUADRIL (femur proximal - colo e pertrocanterica)
 COUNT(DISTINCT CASE 
 WHEN c.CD_CID IN ('S720', 'S721') 
 THEN a.CD_ATENDIMENTO 
 END) AS QTD_QUADRIL,
 
 ROUND(AVG(CASE 
 WHEN c.CD_CID IN ('S720', 'S721') 
 THEN TRUNC(NVL(a.DT_ALTA, SYSDATE)) - TRUNC(a.DT_ATENDIMENTO)
 END), 1) AS MEDIA_QUADRIL,
 
 -- FRATURA DE FEMUR (todo o femur EXCETO quadril para evitar duplicacao)
 COUNT(DISTINCT CASE 
 WHEN c.CD_CID LIKE 'S72%' AND c.CD_CID NOT IN ('S720', 'S721')
 THEN a.CD_ATENDIMENTO 
 END) AS QTD_FEMUR,
 
 ROUND(AVG(CASE 
 WHEN c.CD_CID LIKE 'S72%' AND c.CD_CID NOT IN ('S720', 'S721')
 THEN TRUNC(NVL(a.DT_ALTA, SYSDATE)) - TRUNC(a.DT_ATENDIMENTO)
 END), 1) AS MEDIA_FEMUR

FROM 
 DBAMV.ATENDIME a
 INNER JOIN DBAMV.CID c ON a.CD_CID = c.CD_CID

WHERE 
 a.TP_ATENDIMENTO = 'I'
 AND (c.CD_CID LIKE 'S12%' OR c.CD_CID LIKE 'S22%' OR c.CD_CID LIKE 'S32%' OR c.CD_CID LIKE 'S72%')
 AND a.DT_ATENDIMENTO >= TO_DATE('01/06/2024', 'DD/MM/YYYY')
 AND a.DT_ATENDIMENTO <= TO_DATE('30/09/2025', 'DD/MM/YYYY')
 AND a.DT_ALTA IS NOT NULL

GROUP BY 
 TO_CHAR(a.DT_ATENDIMENTO, 'YYYY-MM'),
 TO_CHAR(a.DT_ATENDIMENTO, 'MM/YYYY')

ORDER BY 
 ORDEM DESC
