-- NOME: HUGO - CENSO DE LEITOS COMPLETO (v13 - Com Horário da Coleta)
-- DESCRICAO: Retorna o status de todos os leitos com um carimbo de data/hora na primeira linha,
--            incluindo detalhes de reserva, tipo de leito e solicitações de transferência.
-- FONTE: DBAMV
-- ATUALIZADO EM: 2025-10-19

WITH
-- CTE 1: Encontra a data da última movimentação para o leito atual de cada atendimento
CTE_ULTIMA_MOVIMENTACAO AS (
    SELECT
        MI.CD_ATENDIMENTO,
        MI.CD_LEITO,
        MAX(MI.HR_MOV_INT) AS DH_ENTRADA_LEITO
    FROM DBAMV.MOV_INT MI
    GROUP BY
        MI.CD_ATENDIMENTO,
        MI.CD_LEITO
),

-- CTE 2: Busca detalhes da solicitação de leito pendente com as colunas corretas
CTE_SOLICITACOES AS (
    SELECT
        CD_ATENDIMENTO,
        DH_ULTIMA_SOLICITACAO,
        ACOMODACAO_SOLICITADA,
        MOTIVO_SOLICITACAO
    FROM (
        SELECT
            STL.CD_ATENDIMENTO,
            STL.DH_SOLICITACAO AS DH_ULTIMA_SOLICITACAO,
            TA.DS_TIP_ACOM AS ACOMODACAO_SOLICITADA,
            MTL.DS_MOTIVO_TRANSF_LEITO AS MOTIVO_SOLICITACAO,
            ROW_NUMBER() OVER(PARTITION BY STL.CD_ATENDIMENTO ORDER BY STL.DH_SOLICITACAO DESC) as RN
        FROM DBAMV.SOLIC_TRANSFERENCIA_LEITO STL
        LEFT JOIN DBAMV.TIP_ACOM TA ON STL.CD_TIP_ACOM = TA.CD_TIP_ACOM
        LEFT JOIN DBAMV.MOTIVO_TRANSF_LEITO MTL ON STL.CD_MOTIVO_TRANSF_LEITO = MTL.CD_MOTIVO_TRANSF_LEITO
        WHERE NOT EXISTS (
            SELECT 1
            FROM DBAMV.MOV_INT MI
            WHERE MI.CD_ATENDIMENTO = STL.CD_ATENDIMENTO
              AND MI.TP_MOV = 'O'
              AND MI.HR_MOV_INT > STL.DH_SOLICITACAO
        )
    )
    WHERE RN = 1
),

-- CTE 3: Busca leitos que estão reservados, incluindo a data da reserva
CTE_RESERVAS AS (
    SELECT
        MI.CD_LEITO,
        MI.CD_ATENDIMENTO,
        P.NM_PACIENTE,
        MI.HR_MOV_INT AS DH_RESERVA
    FROM DBAMV.MOV_INT MI
    JOIN DBAMV.ATENDIME A ON MI.CD_ATENDIMENTO = A.CD_ATENDIMENTO
    JOIN DBAMV.PACIENTE P ON A.CD_PACIENTE = P.CD_PACIENTE
    WHERE MI.SN_RESERVA = 'S'
      AND MI.DT_LIB_MOV IS NULL
      AND A.DT_ALTA IS NULL
      AND A.CD_MULTI_EMPRESA = 40
),

-- CTE 4: Junta todos os dados do censo de leitos
DADOS_CENSO AS (
    SELECT
        UI.DS_UNID_INT AS UNIDADE_INTERNACAO,
        L.DS_LEITO AS LEITO,
        CASE WHEN L.SN_EXTRA = 'S' THEN 'SIM' ELSE 'NÃO' END AS LEITO_VIRTUAL_EXTRA,
        CASE
            WHEN L.TP_OCUPACAO = 'O' THEN 'OCUPADO'
            WHEN L.TP_OCUPACAO = 'V' THEN 'VAGO'
            WHEN L.TP_OCUPACAO = 'L' THEN 'EM LIMPEZA'
            WHEN L.TP_OCUPACAO = 'R' THEN 'RESERVADO'
            WHEN L.TP_OCUPACAO IN ('M', 'E', 'N', 'C', 'T') THEN 'BLOQUEADO'
            ELSE L.TP_OCUPACAO
        END AS STATUS_LEITO,
        CASE
            WHEN L.TP_OCUPACAO = 'M' THEN 'Manutenção'
            WHEN L.TP_OCUPACAO = 'E' THEN 'Reforma'
            WHEN L.TP_OCUPACAO = 'N' THEN 'Interdição'
            WHEN L.TP_OCUPACAO = 'C' THEN 'Interditado por Infecção'
            WHEN L.TP_OCUPACAO = 'T' THEN 'Interditado Temporariamente'
            WHEN L.TP_OCUPACAO = 'R' THEN 'Reservado para: ' || SUBSTR(RES.NM_PACIENTE, 1, 30)
            ELSE NULL
        END AS MOTIVO_BLOQUEIO_RESERVA,
        TO_CHAR(RES.DH_RESERVA, 'DD/MM/YYYY HH24:MI') AS DATA_HORA_RESERVA,
        A.CD_ATENDIMENTO,
        P.NM_PACIENTE AS PACIENTE_ATUAL,
        TRUNC(SYSDATE - A.DT_ATENDIMENTO) AS DIAS_INTERNADO,
        CASE
            WHEN UM.DH_ENTRADA_LEITO IS NOT NULL THEN
                TRUNC(SYSDATE - UM.DH_ENTRADA_LEITO) || 'd ' ||
                TRUNC(MOD((SYSDATE - UM.DH_ENTRADA_LEITO) * 24, 24)) || 'h'
            ELSE NULL
        END AS TEMPO_NO_LEITO_ATUAL,
        CASE WHEN SOL.CD_ATENDIMENTO IS NOT NULL THEN 'SIM' ELSE 'NÃO' END AS SOLICITACAO_PENDENTE,
        TO_CHAR(SOL.DH_ULTIMA_SOLICITACAO, 'DD/MM/YYYY HH24:MI') AS DATA_ULTIMA_SOLICITACAO,
        SOL.ACOMODACAO_SOLICITADA,
        SOL.MOTIVO_SOLICITACAO
    FROM
        DBAMV.LEITO L
        INNER JOIN DBAMV.UNID_INT UI ON L.CD_UNID_INT = UI.CD_UNID_INT
        INNER JOIN DBAMV.SETOR S ON UI.CD_SETOR = S.CD_SETOR
        LEFT JOIN DBAMV.ATENDIME A ON L.CD_LEITO = A.CD_LEITO AND A.DT_ALTA IS NULL
        LEFT JOIN DBAMV.PACIENTE P ON A.CD_PACIENTE = P.CD_PACIENTE
        LEFT JOIN CTE_ULTIMA_MOVIMENTACAO UM ON A.CD_ATENDIMENTO = UM.CD_ATENDIMENTO AND L.CD_LEITO = UM.CD_LEITO
        LEFT JOIN CTE_SOLICITACOES SOL ON A.CD_ATENDIMENTO = SOL.CD_ATENDIMENTO
        LEFT JOIN CTE_RESERVAS RES ON L.CD_LEITO = RES.CD_LEITO
    WHERE
        S.CD_MULTI_EMPRESA = 40
        AND L.TP_SITUACAO <> 'I'
        AND UI.SN_ATIVO = 'S'
)

-- Consulta Final: Combina a linha de cabeçalho com os dados
SELECT
    -- Linha 1: Cabeçalho com o horário
    'DADOS COLETADOS EM: ' || TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI:SS') AS UNIDADE_INTERNACAO,
    NULL AS LEITO, NULL AS LEITO_VIRTUAL_EXTRA, NULL AS STATUS_LEITO, NULL AS MOTIVO_BLOQUEIO_RESERVA,
    NULL AS DATA_HORA_RESERVA, NULL AS CD_ATENDIMENTO, NULL AS PACIENTE_ATUAL, NULL AS DIAS_INTERNADO,
    NULL AS TEMPO_NO_LEITO_ATUAL, NULL AS SOLICITACAO_PENDENTE, NULL AS DATA_ULTIMA_SOLICITACAO,
    NULL AS ACOMODACAO_SOLICITADA, NULL AS MOTIVO_SOLICITACAO,
    1 AS ORDEM -- Coluna de ordenação para garantir que esta linha venha primeiro
FROM DUAL

UNION ALL

-- Linhas seguintes: Dados do censo de leitos
SELECT
    UNIDADE_INTERNACAO, LEITO, LEITO_VIRTUAL_EXTRA, STATUS_LEITO, MOTIVO_BLOQUEIO_RESERVA,
    DATA_HORA_RESERVA, CD_ATENDIMENTO, PACIENTE_ATUAL, DIAS_INTERNADO, TEMPO_NO_LEITO_ATUAL,
    SOLICITACAO_PENDENTE, DATA_ULTIMA_SOLICITACAO, ACOMODACAO_SOLICITADA, MOTIVO_SOLICITACAO,
    2 AS ORDEM -- Coluna de ordenação
FROM DADOS_CENSO

ORDER BY
    ORDEM, -- Garante que a linha de cabeçalho venha primeiro
    UNIDADE_INTERNACAO,
    LEITO
