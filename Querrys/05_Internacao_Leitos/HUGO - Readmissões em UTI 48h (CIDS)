WITH params AS (
    SELECT
        $pgmvDataIni$ AS dtini,
        $pgmvDataFim$ AS dtfim
    FROM dual
)
SELECT
    BASE.CD_MOV_INT,
    BASE.CD_ATENDIMENTO,
    BASE.CD_PACIENTE,
    BASE.NM_PACIENTE,
    BASE.UNIDADE_ATUAL,
    BASE.UNIDADE_ANTERIOR,
    BASE.ULTIMA_UTI_ANTES_READMISSAO,
    TO_CHAR(BASE.DH_MOV_INT, 'DD/MM/YY HH24:MI') AS DH_MOV_INT,
    TO_CHAR(BASE.DH_LIB_MOV_ANT, 'DD/MM/YY HH24:MI') AS DH_LIB_MOV_ANT,
    TRUNC((BASE.DH_MOV_INT - BASE.DH_LIB_MOV_ANT) * 24) AS DIFH
FROM (
    SELECT
        M.CD_MOV_INT,
        A.CD_ATENDIMENTO,
        A.CD_PACIENTE,
        P.NM_PACIENTE,
        U.DS_UNID_INT AS UNIDADE_ATUAL,
        (
            SELECT U2.DS_UNID_INT
            FROM DBAMV.MOV_INT M2
            JOIN DBAMV.LEITO L2 ON M2.CD_LEITO = L2.CD_LEITO
            JOIN DBAMV.UNID_INT U2 ON L2.CD_UNID_INT = U2.CD_UNID_INT
            WHERE M2.CD_MOV_INT = (
                SELECT MAX(M3.CD_MOV_INT)
                FROM DBAMV.MOV_INT M3
                JOIN DBAMV.LEITO L3 ON M3.CD_LEITO = L3.CD_LEITO
                JOIN DBAMV.TIP_ACOM TA3 ON L3.CD_TIP_ACOM = TA3.CD_TIP_ACOM
                WHERE M3.CD_ATENDIMENTO = A.CD_ATENDIMENTO
                  AND M3.CD_MOV_INT < M.CD_MOV_INT
                  AND TA3.TP_ACOMODACAO NOT IN ('U','I')
            )
        ) AS UNIDADE_ANTERIOR,
        (
            SELECT U3.DS_UNID_INT
            FROM DBAMV.MOV_INT M4
            JOIN DBAMV.LEITO L4 ON M4.CD_LEITO = L4.CD_LEITO
            JOIN DBAMV.UNID_INT U3 ON L4.CD_UNID_INT = U3.CD_UNID_INT
            WHERE M4.CD_MOV_INT = (
                SELECT MAX(M5.CD_MOV_INT)
                FROM DBAMV.MOV_INT M5
                JOIN DBAMV.LEITO L5 ON M5.CD_LEITO = L5.CD_LEITO
                JOIN DBAMV.UNID_INT U5 ON L5.CD_UNID_INT = U5.CD_UNID_INT
                WHERE M5.CD_ATENDIMENTO = A.CD_ATENDIMENTO
                  AND M5.CD_MOV_INT < M.CD_MOV_INT
                  AND M5.TP_MOV IN ('O','I')
                  AND U5.CD_UNID_INT IN (564, 565, 566, 567)
            )
        ) AS ULTIMA_UTI_ANTES_READMISSAO,
        TO_DATE(TO_CHAR(M.DT_MOV_INT,'DD/MM/YYYY')||' '||TO_CHAR(M.HR_MOV_INT,'HH24:MI'),'DD/MM/YYYY HH24:MI') AS DH_MOV_INT,
        (
            SELECT TO_DATE(TO_CHAR(MOV2.DT_LIB_MOV,'DD/MM/YYYY')||' '||TO_CHAR(MOV2.HR_LIB_MOV,'HH24:MI'),'DD/MM/YYYY HH24:MI')
            FROM DBAMV.MOV_INT MOV2
            WHERE MOV2.CD_MOV_INT = (
                SELECT MAX(MOV.CD_MOV_INT)
                FROM DBAMV.MOV_INT MOV
                JOIN DBAMV.LEITO L2 ON MOV.CD_LEITO = L2.CD_LEITO
                JOIN DBAMV.UNID_INT U2 ON L2.CD_UNID_INT = U2.CD_UNID_INT
                WHERE MOV.CD_ATENDIMENTO = A.CD_ATENDIMENTO
                  AND MOV.TP_MOV IN ('O','I')
                  AND U2.CD_UNID_INT IN (564, 565, 566, 567)
                  AND MOV.CD_MOV_INT < M.CD_MOV_INT
            )
        ) AS DH_LIB_MOV_ANT
    FROM
        DBAMV.MOV_INT M
    JOIN DBAMV.LEITO L ON M.CD_LEITO = L.CD_LEITO
    JOIN DBAMV.UNID_INT U ON L.CD_UNID_INT = U.CD_UNID_INT
    JOIN DBAMV.ATENDIME A ON M.CD_ATENDIMENTO = A.CD_ATENDIMENTO
    JOIN DBAMV.PACIENTE P ON A.CD_PACIENTE = P.CD_PACIENTE
    CROSS JOIN params p
    WHERE
        M.TP_MOV = 'O'
        AND U.CD_UNID_INT IN (564, 565, 566, 567)
        AND A.CD_MULTI_EMPRESA = 40
        AND TRUNC(M.DT_MOV_INT) BETWEEN p.dtini AND p.dtfim
        AND NOT EXISTS (
            SELECT 1
            FROM DBAMV.LEITO L3
            JOIN DBAMV.TIP_ACOM TA3 ON L3.CD_TIP_ACOM = TA3.CD_TIP_ACOM
            WHERE L3.CD_LEITO = M.CD_LEITO_ANTERIOR
              AND TA3.TP_ACOMODACAO IN ('U','I')
        )
) BASE
WHERE
    BASE.DH_LIB_MOV_ANT IS NOT NULL
    AND TRUNC((BASE.DH_MOV_INT - BASE.DH_LIB_MOV_ANT) * 24) >= 1 -- <--- MODIFICAÇÃO APLICADA AQUI
    AND TRUNC((BASE.DH_MOV_INT - BASE.DH_LIB_MOV_ANT) * 24) < 48
    AND BASE.UNIDADE_ANTERIOR NOT IN ('CENTRO CIRURGICO - HUGO', 'HOSPITAL DIA - HUGO')
ORDER BY
    BASE.DH_MOV_INT DESC
