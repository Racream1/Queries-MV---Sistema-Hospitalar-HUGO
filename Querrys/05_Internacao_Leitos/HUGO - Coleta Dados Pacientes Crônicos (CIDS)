SELECT
    base.NM_PACIENTE,
    base.CD_ATENDIMENTO,
    TRUNC(base.DT_ATENDIMENTO) AS DATA_ADMISSAO,
    base.DIAS_DE_PERMANENCIA,
    base.DS_LEITO AS LEITO_ATUAL,
    base.DS_UNID_INT AS UNIDADE_ATUAL,
    base.DS_ESPECIALID AS ESPECIALIDADE_ATUAL,
    
    COALESCE(par.PARECERES_PENDENTES, 'Nenhum') AS PARECERES_PENDENTES,

    CASE 
        WHEN cr.CD_ATENDIMENTO IS NOT NULL THEN 'Sim' 
        ELSE 'Não' 
    END AS PASSOU_POR_CIRURGIA,
    
    CASE 
        WHEN cp.CD_ATENDIMENTO IS NOT NULL THEN 'Sim' 
        ELSE 'Não' 
    END AS AVISO_CIRURGICO_PENDENTE,
    
    COALESCE(atb.ANTIBIOTICOS_EM_USO, 'Nenhum ATB prescrito nas últimas 24h') AS ANTIBIOTICOS_RECENTES
    
FROM
    ( -- 1) BASE DE PACIENTES
        SELECT
            pac.NM_PACIENTE, atd.CD_ATENDIMENTO, atd.DT_ATENDIMENTO,
            TRUNC(SYSDATE) - TRUNC(atd.DT_ATENDIMENTO) AS DIAS_DE_PERMANENCIA,
            lt.DS_LEITO, unid.DS_UNID_INT, esp.DS_ESPECIALID
        FROM DBAMV.ATENDIME atd
            JOIN DBAMV.PACIENTE pac ON pac.CD_PACIENTE = atd.CD_PACIENTE
            LEFT JOIN DBAMV.LEITO lt ON atd.CD_LEITO = lt.CD_LEITO
            LEFT JOIN DBAMV.UNID_INT unid ON lt.CD_UNID_INT = unid.CD_UNID_INT
            LEFT JOIN DBAMV.ESPECIALID esp ON atd.CD_ESPECIALID = esp.CD_ESPECIALID
        WHERE atd.CD_MULTI_EMPRESA = 40 AND atd.TP_ATENDIMENTO = 'I' AND atd.DT_ALTA IS NULL
          AND (TRUNC(SYSDATE) - TRUNC(atd.DT_ATENDimento)) >= 30
    ) base

LEFT JOIN
    ( -- 2) ANTIBIÓTICOS PRESCRITOS NAS ÚLTIMAS 24H - LÓGICA SIMPLIFICADA
        SELECT
            CD_ATENDIMENTO,
            LISTAGG(DS_PRODUTO || ' (' || NR_DIA || '/' || QT_DIAS || ' dia)', '; ') 
            WITHIN GROUP (ORDER BY DS_PRODUTO) AS ANTIBIOTICOS_EM_USO
        FROM (
            SELECT
                pre.CD_ATENDIMENTO,
                prod.DS_PRODUTO,
                itpre.NR_DIA,
                itpre.QT_DIAS,
                ROW_NUMBER() OVER (PARTITION BY pre.CD_ATENDIMENTO, itpre.CD_PRODUTO ORDER BY pre.HR_PRE_MED DESC) AS rn
            FROM 
                DBAMV.PRE_MED pre
                JOIN DBAMV.ITPRE_MED itpre ON itpre.CD_PRE_MED = pre.CD_PRE_MED
                JOIN DBAMV.TIP_PRESC tp ON itpre.CD_TIP_PRESC = tp.CD_TIP_PRESC
                JOIN DBAMV.PRODUTO prod ON itpre.CD_PRODUTO = prod.CD_PRODUTO
            WHERE
                tp.CD_TIP_ESQ = 'ATB'
                -- AQUI ESTÁ A LÓGICA CORRETA E SIMPLES, COMO VOCÊ PEDIU
                AND pre.HR_PRE_MED >= SYSDATE - 1 
        )
        WHERE rn = 1
        GROUP BY CD_ATENDIMENTO
    ) atb ON base.CD_ATENDIMENTO = atb.CD_ATENDIMENTO

LEFT JOIN
    ( -- 3) CIRURGIAS REALIZADAS
        SELECT DISTINCT CD_ATENDIMENTO FROM DBAMV.AVISO_CIRURGIA WHERE TP_SITUACAO = 'R'
    ) cr ON base.CD_ATENDIMENTO = cr.CD_ATENDIMENTO

LEFT JOIN
    ( -- 4) CIRURGIAS PENDENTES
        SELECT DISTINCT CD_ATENDIMENTO FROM DBAMV.AVISO_CIRURGIA WHERE TP_SITUACAO IN ('G', 'A')
    ) cp ON base.CD_ATENDIMENTO = cp.CD_ATENDIMENTO

LEFT JOIN
    ( -- 5) PARECERES PENDENTES
        SELECT
            pm.CD_ATENDIMENTO,
            LISTAGG(esp.DS_ESPECIALID, '; ') WITHIN GROUP (ORDER BY pm.DT_SOLICITACAO) AS PARECERES_PENDENTES
        FROM DBAMV.PAR_MED pm
            JOIN DBAMV.ESPECIALID esp ON pm.CD_ESPECIALID = esp.CD_ESPECIALID
        WHERE pm.DS_SITUACAO IN ('Solicitado', 'Em Análise', 'Em Analise')
        GROUP BY pm.CD_ATENDIMENTO
    ) par ON base.CD_ATENDIMENTO = par.CD_ATENDIMENTO

ORDER BY
    base.DIAS_DE_PERMANENCIA DESC
