-- ========================================
-- PORTLET: TEMPO MEDIO ENTRE RESERVA E ACOMODACAO POR MES
-- Descricao: Analise mensal do intervalo entre reserva e ocupacao
-- Periodo: Ano atual 2025
-- VERSAO CORRIGIDA: Tratamento de data/hora
-- ========================================

WITH PARAMETROS_AUTOMATICOS AS (
    SELECT 
        TO_DATE('01/01/2025', 'DD/MM/YYYY') AS DATA_INICIO,
        LAST_DAY(ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -1)) AS DATA_FIM
    FROM DUAL
),

RESERVAS_BASE AS (
    SELECT 
        mi.CD_MOV_INT,
        mi.CD_ATENDIMENTO,
        mi.CD_LEITO,
        mi.DT_MOV_INT,
        mi.DT_LIB_MOV,
        
        -- Usa funcao MV para recuperar data/hora corretamente
        DBAMV.FNC_MV_RECUPERA_DATA_HORA(mi.DT_MOV_INT, mi.HR_MOV_INT) AS DH_RESERVA,
        DBAMV.FNC_MV_RECUPERA_DATA_HORA(mi.DT_LIB_MOV, mi.HR_LIB_MOV) AS DH_ACOMODACAO,
        
        TO_CHAR(mi.DT_MOV_INT, 'YYYY-MM') AS ANO_MES,
        TO_CHAR(mi.DT_MOV_INT, 'MM/YYYY') AS MES_ANO_EXIBICAO
        
    FROM DBAMV.MOV_INT mi
    CROSS JOIN PARAMETROS_AUTOMATICOS pa
    INNER JOIN DBAMV.LEITO l 
        ON mi.CD_LEITO = l.CD_LEITO
    INNER JOIN DBAMV.ATENDIME a
        ON mi.CD_ATENDIMENTO = a.CD_ATENDIMENTO
        AND a.CD_MULTI_EMPRESA = 40
    
    WHERE 
        mi.DT_MOV_INT BETWEEN pa.DATA_INICIO AND pa.DATA_FIM
        AND mi.SN_RESERVA = 'S'
        AND mi.DT_LIB_MOV IS NOT NULL
        AND mi.HR_LIB_MOV IS NOT NULL
        AND mi.HR_MOV_INT IS NOT NULL
),

CALCULOS_MENSAIS AS (
    SELECT 
        ANO_MES,
        MES_ANO_EXIBICAO,
        (DH_ACOMODACAO - DH_RESERVA) * 24 AS TEMPO_ESPERA_HORAS
        
    FROM RESERVAS_BASE
    WHERE 
        DH_RESERVA IS NOT NULL
        AND DH_ACOMODACAO IS NOT NULL
        AND (DH_ACOMODACAO - DH_RESERVA) * 24 >= 0
        AND (DH_ACOMODACAO - DH_RESERVA) * 24 <= 720
)

SELECT 
    MES_ANO_EXIBICAO AS MES_ANO,
    
    COUNT(*) AS QTD_RESERVAS,
    
    ROUND(AVG(TEMPO_ESPERA_HORAS), 2) AS TEMPO_MEDIO_HORAS,
    
    TRUNC(AVG(TEMPO_ESPERA_HORAS) / 24) || 'D ' ||
    TRUNC(MOD(AVG(TEMPO_ESPERA_HORAS), 24)) || 'H ' ||
    TRUNC(MOD(AVG(TEMPO_ESPERA_HORAS) * 60, 60)) || 'M' AS TEMPO_MEDIO_FORMATADO,
    
    ROUND(MIN(TEMPO_ESPERA_HORAS), 2) AS TEMPO_MINIMO_HORAS,
    
    ROUND(MAX(TEMPO_ESPERA_HORAS), 2) AS TEMPO_MAXIMO_HORAS,
    
    ROUND(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY TEMPO_ESPERA_HORAS), 2) AS MEDIANA_HORAS,
    
    SUM(CASE WHEN TEMPO_ESPERA_HORAS <= 1 THEN 1 ELSE 0 END) AS ATE_1H,
    SUM(CASE WHEN TEMPO_ESPERA_HORAS > 1 AND TEMPO_ESPERA_HORAS <= 4 THEN 1 ELSE 0 END) AS DE_1H_A_4H,
    SUM(CASE WHEN TEMPO_ESPERA_HORAS > 4 AND TEMPO_ESPERA_HORAS <= 12 THEN 1 ELSE 0 END) AS DE_4H_A_12H,
    SUM(CASE WHEN TEMPO_ESPERA_HORAS > 12 AND TEMPO_ESPERA_HORAS <= 24 THEN 1 ELSE 0 END) AS DE_12H_A_24H,
    SUM(CASE WHEN TEMPO_ESPERA_HORAS > 24 THEN 1 ELSE 0 END) AS MAIS_DE_24H
    
FROM CALCULOS_MENSAIS

GROUP BY 
    ANO_MES,
    MES_ANO_EXIBICAO

ORDER BY 
    ANO_MES ASC
