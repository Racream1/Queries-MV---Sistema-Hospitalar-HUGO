SELECT 
    L.DS_RESUMO AS LEITO,
    P.NM_PACIENTE AS PACIENTE,
    TO_CHAR(P.DT_NASCIMENTO, 'DD/MM/YYYY') AS NASCIMENTO,
    ROUND((SYSDATE - P.DT_NASCIMENTO) / 365) AS IDADE,
    A.CD_ATENDIMENTO AS ATENDIMENTO,
    C.NM_CONVENIO AS CONVENIO,
    PR.NM_PRESTADOR AS MEDICO,
    TO_CHAR(A.DT_ATENDIMENTO, 'DD/MM/YY HH24:MI') AS INTERNACAO,
    TRUNC(SYSDATE - A.DT_ATENDIMENTO) AS DIAS,
    U.DS_UNID_INT AS UNIDADE,
    
    -- Prescrição Médica (hoje)
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM DBAMV.PRE_MED PM
            WHERE PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
            AND TRUNC(PM.DT_PRE_MED) = TRUNC(SYSDATE)
        ) THEN 'SIM'
        ELSE 'NÃO'
    END AS PRESCRICAO,
    
    -- Evolução Médica (hoje)
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM DBAMV.PRE_MED PM
            WHERE PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
            AND TRUNC(PM.DT_PRE_MED) = TRUNC(SYSDATE)
            AND PM.DS_EVOLUCAO IS NOT NULL
        ) THEN 'SIM'
        ELSE 'NÃO'
    END AS EVOLUCAO_MEDICA,
    
    -- Cirurgia Agendada (próximos 7 dias)
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM DBAMV.AVISO_CIRURGIA AC
            WHERE AC.CD_ATENDIMENTO = A.CD_ATENDIMENTO
            AND AC.DT_REALIZACAO BETWEEN TRUNC(SYSDATE) AND TRUNC(SYSDATE) + 7
            AND AC.TP_SITUACAO = 'A'
        ) THEN 'SIM'
        ELSE 'NÃO'
    END AS CIRURGIA_AGENDADA,
    
    -- Exames Realizados (hoje)
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM DBAMV.PED_RX PR
            INNER JOIN DBAMV.ITPED_RX IPR ON PR.CD_PED_RX = IPR.CD_PED_RX
            WHERE PR.CD_ATENDIMENTO = A.CD_ATENDIMENTO
            AND IPR.SN_REALIZADO = 'S'
            AND TRUNC(IPR.DT_REALIZADO) = TRUNC(SYSDATE)
        ) THEN 'SIM'
        ELSE 'NÃO'
    END AS EXAMES_HOJE,
    
    -- Pareceres Pendentes
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM DBAMV.PAR_MED PM
            WHERE PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
            AND PM.DS_SITUACAO IN ('Solicitado', 'Em Análise')
        ) THEN 'PENDENTE'
        ELSE NULL
    END AS PARECER,
    
    -- Data da Alta Médica
    TO_CHAR(A.DT_ALTA_MEDICA, 'DD/MM/YY HH24:MI') AS ALTA_MEDICA,
    
    -- Status do Atendimento
    CASE 
        WHEN A.DT_ALTA_MEDICA IS NOT NULL AND A.DT_ALTA IS NULL THEN 'ALTA MÉDICA'
        WHEN A.DT_ALTA IS NOT NULL THEN 'ALTA ADMIN'
        ELSE 'INTERNADO'
    END AS STATUS,
    
    -- Status do Leito
    CASE L.TP_OCUPACAO
        WHEN 'O' THEN 'OCUPADO'
        WHEN 'V' THEN 'VAGO'
        WHEN 'L' THEN 'LIMPEZA'
        WHEN 'R' THEN 'RESERVA'
        WHEN 'M' THEN 'MANUTENÇÃO'
        ELSE L.TP_OCUPACAO
    END AS STATUS_LEITO,
    
    -- CID Principal
    (SELECT CID.DS_CID 
     FROM DBAMV.CID 
     WHERE CID.CD_CID = A.CD_CID
    ) AS DIAGNOSTICO

FROM DBAMV.ATENDIME A
    INNER JOIN DBAMV.PACIENTE P ON A.CD_PACIENTE = P.CD_PACIENTE
    INNER JOIN DBAMV.LEITO L ON A.CD_LEITO = L.CD_LEITO
    INNER JOIN DBAMV.UNID_INT U ON L.CD_UNID_INT = U.CD_UNID_INT
    INNER JOIN DBAMV.SETOR S ON U.CD_SETOR = S.CD_SETOR
    LEFT JOIN DBAMV.PRESTADOR PR ON A.CD_PRESTADOR = PR.CD_PRESTADOR
    LEFT JOIN DBAMV.CONVENIO C ON A.CD_CONVENIO = C.CD_CONVENIO

WHERE A.DT_ALTA IS NULL
    AND S.CD_MULTI_EMPRESA = 40
    AND (#P_UNIDADE# IS NULL OR L.CD_UNID_INT = #P_UNIDADE#)

ORDER BY L.DS_RESUMO
