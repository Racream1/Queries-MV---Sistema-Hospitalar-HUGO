SELECT 
    ME.CD_MVTO_ESTOQUE,
    TO_CHAR(ME.DT_MVTO_ESTOQUE, 'DD/MM/YYYY HH24:MI') AS DATA_SAIDA,
    E.DS_ESTOQUE,
    P.DS_PRODUTO AS ANTIMICROBIANO,
    IME.QT_MOVIMENTACAO AS QUANTIDADE,
    A.CD_ATENDIMENTO,
    PAC.NM_PACIENTE,
    L.DS_LEITO,
    S.NM_SETOR,
    
    -- CLASSIFICAÇÃO
    CASE 
        WHEN UPPER(P.DS_PRODUTO) LIKE '%MEROPENEM%' OR UPPER(P.DS_PRODUTO) LIKE '%IMIPENEM%' THEN 'CARBAPENEMICO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%POLIMIXINA%' OR UPPER(P.DS_PRODUTO) LIKE '%COLISTIN%' THEN 'POLIMIXINA'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%VANCOMICINA%' OR UPPER(P.DS_PRODUTO) LIKE '%TEICOPLANINA%' THEN 'GLICOPEPTIDEO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%LINEZOLIDA%' THEN 'OXAZOLIDINONA'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%CEFAZOLINA%' OR UPPER(P.DS_PRODUTO) LIKE '%CEFALOTINA%' THEN 'CEFALOSPORINA 1G'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%CEFTRIAXONA%' OR UPPER(P.DS_PRODUTO) LIKE '%CEFTAZIDIMA%' THEN 'CEFALOSPORINA 3G'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%CEFEPIME%' THEN 'CEFALOSPORINA 4G'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%PIPERACILINA%' THEN 'PENICILINA+INIB'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%AMPICILINA%' AND UPPER(P.DS_PRODUTO) LIKE '%SULBACTAM%' THEN 'PENICILINA+INIB'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%CIPROFLOXACIN%' OR UPPER(P.DS_PRODUTO) LIKE '%LEVOFLOXACIN%' THEN 'QUINOLONA'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%GENTAMICINA%' OR UPPER(P.DS_PRODUTO) LIKE '%AMICACINA%' THEN 'AMINOGLICOSIDEO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%METRONIDAZOL%' THEN 'NITROIMIDAZOL'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%CLINDAMICINA%' THEN 'LINCOSAMIDA'
        ELSE 'OUTRO'
    END AS CLASSE,
    
    -- CRITICIDADE
    CASE 
        WHEN UPPER(P.DS_PRODUTO) LIKE '%MEROPENEM%' THEN 'CRITICO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%IMIPENEM%' THEN 'CRITICO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%POLIMIXINA%' THEN 'CRITICO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%LINEZOLIDA%' THEN 'CRITICO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%VANCOMICINA%' THEN 'RESTRITO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%PIPERACILINA%' THEN 'RESTRITO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%CEFEPIME%' THEN 'RESTRITO'
        WHEN UPPER(P.DS_PRODUTO) LIKE '%LEVOFLOXACIN%' THEN 'RESTRITO'
        ELSE 'PADRAO'
    END AS CRITICIDADE

FROM DBAMV.MVTO_ESTOQUE ME
    INNER JOIN DBAMV.ITMVTO_ESTOQUE IME ON IME.CD_MVTO_ESTOQUE = ME.CD_MVTO_ESTOQUE
    INNER JOIN DBAMV.PRODUTO P ON P.CD_PRODUTO = IME.CD_PRODUTO
    INNER JOIN DBAMV.ESTOQUE E ON E.CD_ESTOQUE = ME.CD_ESTOQUE
    LEFT JOIN DBAMV.ATENDIME A ON A.CD_ATENDIMENTO = ME.CD_ATENDIMENTO
    LEFT JOIN DBAMV.PACIENTE PAC ON PAC.CD_PACIENTE = A.CD_PACIENTE
    LEFT JOIN DBAMV.LEITO L ON L.CD_LEITO = A.CD_LEITO
    LEFT JOIN DBAMV.UNID_INT UI ON UI.CD_UNID_INT = L.CD_UNID_INT
    LEFT JOIN DBAMV.SETOR S ON S.CD_SETOR = UI.CD_SETOR

WHERE E.CD_MULTI_EMPRESA = 40
    AND ME.DT_MVTO_ESTOQUE >= SYSDATE - 1
    AND UPPER(P.DS_PRODUTO) NOT LIKE '%DOSAGEM%'
    AND UPPER(P.DS_PRODUTO) NOT LIKE '%EXAME%'
    AND (
        UPPER(P.DS_PRODUTO) LIKE '%MEROPENEM%' OR
        UPPER(P.DS_PRODUTO) LIKE '%IMIPENEM%' OR
        UPPER(P.DS_PRODUTO) LIKE '%POLIMIXINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%VANCOMICINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%TEICOPLANINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%LINEZOLIDA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%CEFTAZIDIMA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%CEFTRIAXONA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%CEFEPIME%' OR
        UPPER(P.DS_PRODUTO) LIKE '%CEFAZOLINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%PIPERACILINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%AMPICILINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%CIPROFLOXACIN%' OR
        UPPER(P.DS_PRODUTO) LIKE '%LEVOFLOXACIN%' OR
        UPPER(P.DS_PRODUTO) LIKE '%GENTAMICINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%AMICACINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%AZITROMICINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%METRONIDAZOL%' OR
        UPPER(P.DS_PRODUTO) LIKE '%CLINDAMICINA%' OR
        UPPER(P.DS_PRODUTO) LIKE '%MUPIROCINA%'
    )

ORDER BY 
    CASE 
        WHEN UPPER(P.DS_PRODUTO) LIKE '%MEROPENEM%' THEN 1
        WHEN UPPER(P.DS_PRODUTO) LIKE '%POLIMIXINA%' THEN 1
        WHEN UPPER(P.DS_PRODUTO) LIKE '%LINEZOLIDA%' THEN 1
        WHEN UPPER(P.DS_PRODUTO) LIKE '%VANCOMICINA%' THEN 2
        ELSE 3
    END,
    ME.DT_MVTO_ESTOQUE DESC
