SELECT 
 A.CD_ATENDIMENTO AS CODIGO,
 P.NM_PACIENTE AS PACIENTE,
 TRUNC(MONTHS_BETWEEN(SYSDATE, P.DT_NASCIMENTO) / 12) AS IDADE,
 P.TP_SEXO AS SEXO,
 TO_CHAR(A.HR_ATENDIMENTO, 'DD/MM/YYYY HH24:MI') AS DATA_INTERNACAO,
 TRUNC(SYSDATE - A.DT_ATENDIMENTO) AS DIAS_INTERNACAO,
 L.DS_LEITO AS LEITO,
 UI.DS_UNID_INT AS UNIDADE,
 ESP.DS_ESPECIALID AS ESPECIALIDADE,
 PREST.NM_PRESTADOR AS MEDICO,
 CID.CD_CID AS CID,
 SUBSTR(CID.DS_CID, 1, 50) AS DIAGNOSTICO,
 CASE 
 -- COLUNA
 WHEN CID.CD_CID LIKE 'S12%' OR CID.CD_CID LIKE 'S13%' OR 
 CID.CD_CID LIKE 'S22%' OR CID.CD_CID LIKE 'S23%' OR
 CID.CD_CID LIKE 'S32%' OR CID.CD_CID LIKE 'S33%' OR
 CID.CD_CID LIKE 'M40%' OR CID.CD_CID LIKE 'M41%' OR
 CID.CD_CID LIKE 'M42%' OR CID.CD_CID LIKE 'M43%' OR
 CID.CD_CID LIKE 'M45%' OR CID.CD_CID LIKE 'M46%' OR
 CID.CD_CID LIKE 'M47%' OR CID.CD_CID LIKE 'M48%' OR
 CID.CD_CID LIKE 'M49%' OR CID.CD_CID LIKE 'M50%' OR
 CID.CD_CID LIKE 'M51%' OR CID.CD_CID LIKE 'M53%' OR
 CID.CD_CID LIKE 'M54%' OR CID.CD_CID LIKE 'M96%' OR
 CID.CD_CID LIKE 'M99%' THEN 'COLUNA'
 -- QUADRIL
 WHEN CID.CD_CID LIKE 'S72.0%' OR CID.CD_CID LIKE 'M16%' OR 
 CID.CD_CID LIKE 'S73%' OR CID.CD_CID LIKE 'M87.0%' OR
 CID.CD_CID LIKE 'M87.1%' OR CID.CD_CID LIKE 'M87.2%' OR
 CID.CD_CID LIKE 'Q65%' OR CID.CD_CID LIKE 'M24.85%' OR
 CID.CD_CID LIKE 'M25.55%' OR CID.CD_CID LIKE 'M70.6%' OR
 CID.CD_CID LIKE 'M70.7%' OR CID.CD_CID LIKE 'M91%' OR
 CID.CD_CID LIKE 'M93.0%' THEN 'QUADRIL'
 -- FEMUR PROXIMAL
 WHEN CID.CD_CID LIKE 'S72.0%' OR CID.CD_CID LIKE 'S72.1%' OR 
 CID.CD_CID LIKE 'S72.2%' OR CID.CD_CID LIKE 'S72.3%' OR
 CID.CD_CID LIKE 'M84.4%' OR CID.CD_CID LIKE 'M84.3%' THEN 'FEMUR PROXIMAL'
 ELSE 'OUTROS'
 END AS TIPO_LESAO,
 CASE 
 WHEN TRUNC(SYSDATE - A.DT_ATENDIMENTO) < 1 THEN 'NOVO'
 WHEN TRUNC(SYSDATE - A.DT_ATENDIMENTO) BETWEEN 1 AND 7 THEN 'RECENTE'
 ELSE 'ANTIGO'
 END AS STATUS_TEMPO,
 CASE 
 WHEN MUPI.CD_PRE_MED IS NOT NULL THEN 'SIM'
 ELSE 'NAO'
 END AS TEM_MUPIROCINA,
 TO_CHAR(MUPI.DH_INICIAL, 'DD/MM/YYYY') AS DATA_PRESCRICAO_MUPIROCINA,
 TO_CHAR(MUPI.DH_FINAL, 'DD/MM/YYYY') AS DATA_TERMINO_MUPIROCINA,
 CASE 
 WHEN MUPI.DH_INICIAL IS NOT NULL THEN
 CASE 
 WHEN MUPI.DH_FINAL IS NOT NULL 
 THEN TRUNC(MUPI.DH_FINAL - MUPI.DH_INICIAL)
 ELSE TRUNC(SYSDATE - MUPI.DH_INICIAL)
 END
 ELSE NULL
 END AS DIAS_USO_MUPIROCINA,
 CASE 
 WHEN MUPI.DH_FINAL IS NOT NULL THEN 'FINALIZADO'
 WHEN MUPI.DH_INICIAL IS NOT NULL THEN 'EM USO'
 ELSE NULL
 END AS STATUS_MUPIROCINA,
 CASE 
 WHEN AVC.CD_AVISO_CIRURGIA IS NOT NULL THEN 'SIM'
 ELSE 'NAO'
 END AS TEM_AVISO_CIRURGICO,
 CASE 
 WHEN AVC.TP_SITUACAO = 'A' THEN 'AGENDADO'
 WHEN AVC.TP_SITUACAO = 'R' THEN 'REALIZADO'
 WHEN AVC.TP_SITUACAO = 'C' THEN 'CANCELADO'
 ELSE NULL
 END AS STATUS_CIRURGIA,
 TO_CHAR(AVC.DT_REALIZACAO, 'DD/MM/YYYY') AS DATA_CIRURGIA,
 CIRG.DS_CIRURGIA AS PROCEDIMENTO_CIRURGICO
 
FROM DBAMV.ATENDIME A

INNER JOIN DBAMV.PACIENTE P 
 ON P.CD_PACIENTE = A.CD_PACIENTE

LEFT JOIN DBAMV.LEITO L 
 ON L.CD_LEITO = A.CD_LEITO
 
LEFT JOIN DBAMV.UNID_INT UI 
 ON UI.CD_UNID_INT = L.CD_UNID_INT

LEFT JOIN DBAMV.ESPECIALID ESP 
 ON ESP.CD_ESPECIALID = A.CD_ESPECIALID
 
LEFT JOIN DBAMV.PRESTADOR PREST 
 ON PREST.CD_PRESTADOR = A.CD_PRESTADOR

LEFT JOIN DBAMV.CID 
 ON CID.CD_CID = A.CD_CID

-- BUSCAR PRIMEIRA PRESCRIÇÃO DE MUPIROCINA
LEFT JOIN (
 SELECT 
 PM.CD_ATENDIMENTO,
 PM.CD_PRE_MED,
 IPM.DH_INICIAL,
 IPM.DH_FINAL,
 ROW_NUMBER() OVER (PARTITION BY PM.CD_ATENDIMENTO ORDER BY PM.DT_PRE_MED ASC) AS RN
 FROM DBAMV.PRE_MED PM
 INNER JOIN DBAMV.ITPRE_MED IPM 
 ON PM.CD_PRE_MED = IPM.CD_PRE_MED
 INNER JOIN DBAMV.TIP_PRESC TP 
 ON IPM.CD_TIP_PRESC = TP.CD_TIP_PRESC
 WHERE IPM.SN_CANCELADO = 'N'
 AND UPPER(TP.DS_TIP_PRESC) LIKE '%MUPIROCINA%'
) MUPI ON MUPI.CD_ATENDIMENTO = A.CD_ATENDIMENTO AND MUPI.RN = 1

LEFT JOIN DBAMV.AVISO_CIRURGIA AVC
 ON AVC.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 AND AVC.TP_SITUACAO IN ('A', 'R')

LEFT JOIN DBAMV.CIRURGIA_AVISO CA
 ON CA.CD_AVISO_CIRURGIA = AVC.CD_AVISO_CIRURGIA
 AND CA.SN_PRINCIPAL = 'S'

LEFT JOIN DBAMV.CIRURGIA CIRG
 ON CIRG.CD_CIRURGIA = CA.CD_CIRURGIA

WHERE 1=1
 AND A.CD_MULTI_EMPRESA = 40
 AND A.DT_ATENDIMENTO >= TRUNC(SYSDATE) - 7
 AND A.TP_ATENDIMENTO = 'I'
 AND A.DT_ALTA IS NULL
 AND A.CD_ESPECIALID IN (33, 60, 61)
 AND (
 -- FRATURAS DE COLUNA
 CID.CD_CID LIKE 'S12%' OR CID.CD_CID LIKE 'S13%' OR 
 CID.CD_CID LIKE 'S22%' OR CID.CD_CID LIKE 'S23%' OR
 CID.CD_CID LIKE 'S32%' OR CID.CD_CID LIKE 'S33%' OR
 -- DORSOPATIAS E PROBLEMAS DE COLUNA
 CID.CD_CID LIKE 'M40%' OR CID.CD_CID LIKE 'M41%' OR
 CID.CD_CID LIKE 'M42%' OR CID.CD_CID LIKE 'M43%' OR
 CID.CD_CID LIKE 'M45%' OR CID.CD_CID LIKE 'M46%' OR
 CID.CD_CID LIKE 'M47%' OR CID.CD_CID LIKE 'M48%' OR
 CID.CD_CID LIKE 'M49%' OR CID.CD_CID LIKE 'M50%' OR
 CID.CD_CID LIKE 'M51%' OR CID.CD_CID LIKE 'M53%' OR
 CID.CD_CID LIKE 'M54%' OR CID.CD_CID LIKE 'M96%' OR
 CID.CD_CID LIKE 'M99%' OR
 -- QUADRIL
 CID.CD_CID LIKE 'S72.0%' OR CID.CD_CID LIKE 'M16%' OR 
 CID.CD_CID LIKE 'S73%' OR CID.CD_CID LIKE 'M87.0%' OR
 CID.CD_CID LIKE 'M87.1%' OR CID.CD_CID LIKE 'M87.2%' OR
 CID.CD_CID LIKE 'Q65%' OR CID.CD_CID LIKE 'M24.85%' OR
 CID.CD_CID LIKE 'M25.55%' OR CID.CD_CID LIKE 'M70.6%' OR
 CID.CD_CID LIKE 'M70.7%' OR CID.CD_CID LIKE 'M91%' OR
 CID.CD_CID LIKE 'M93.0%' OR
 -- FEMUR PROXIMAL
 CID.CD_CID LIKE 'S72.1%' OR CID.CD_CID LIKE 'S72.2%' OR 
 CID.CD_CID LIKE 'S72.3%' OR CID.CD_CID LIKE 'M84.4%' OR 
 CID.CD_CID LIKE 'M84.3%'
 )

ORDER BY A.HR_ATENDIMENTO DESC
