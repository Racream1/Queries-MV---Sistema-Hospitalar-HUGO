SELECT CD_ATENDIMENTO ATENDIMENTO,
        CD_PACIENTE PRONTUARIO,
        NM_PACIENTE PACIENTE,
        HR_ATENDIMENTO,
        DS_TIP_PRESC,
        HR_PRE_MED,
        QT_ITPRE_MED,
        DS_UNIDADE,
        FREQUENCIA,
        TRUNC(HR_PRE_MED - HR_ATENDIMENTO) || ' ' || TRUNC(MOD((HR_PRE_MED - HR_ATENDIMENTO) * 24, 24)) || ':' ||
        TRUNC(MOD((HR_PRE_MED - HR_ATENDIMENTO) * 24 * 60, 60))  TEMPO_ESPERA,
        TRUNC(DT_ALTA - HR_ATENDIMENTO) || ' ' || TRUNC(MOD((DT_ALTA - HR_ATENDIMENTO) * 24, 24)) || ':' ||
        TRUNC(MOD((DT_ALTA - HR_ATENDIMENTO) * 24 * 60, 60))  TEMPO_INTERNADO,
        CASE WHEN TP_ATENDIMENTO = 'U' THEN DS_TIP_RES ELSE DS_MOT_ALT END ALTA,
        RN
FROM
(WITH ANTIBIOTICOS AS (
    SELECT 'CEFAZOLINA' termo FROM dual UNION ALL
    SELECT 'CLINDAMICINA' FROM dual UNION ALL
    SELECT 'GENTAMICINA' FROM dual UNION ALL
    SELECT 'CEFTRIAXONA' FROM dual
),
DADOS AS (
    SELECT A.CD_ATENDIMENTO,
           A.CD_PACIENTE,
           P.NM_PACIENTE,
           TO_DATE(TO_CHAR(A.DT_ATENDIMENTO, 'DD/MM/YYYY') || ' ' || TO_CHAR(A.HR_ATENDIMENTO,'HH24:MI:SS'),'DD/MM/YYYY HH24:MI:SS') HR_ATENDIMENTO,
           TP.CD_TIP_PRESC,
           TP.DS_TIP_PRESC,
           PM.HR_PRE_MED,
           IPM.QT_ITPRE_MED,
           TF.DS_TIP_FRE FREQUENCIA,
           UP.DS_UNIDADE,
           ROW_NUMBER() OVER (PARTITION BY A.CD_ATENDIMENTO ORDER BY PM.DT_PRE_MED ASC) AS RN,
           A.DT_ALTA,
           A.TP_ATENDIMENTO,
           MA.DS_MOT_ALT,
           TR.DS_TIP_RES
    FROM PRE_MED PM
    INNER JOIN ITPRE_MED IPM ON IPM.CD_PRE_MED = PM.CD_PRE_MED
    INNER JOIN TIP_PRESC TP   ON TP.CD_TIP_PRESC = IPM.CD_TIP_PRESC
    INNER JOIN ATENDIME A     ON A.CD_ATENDIMENTO = PM.CD_ATENDIMENTO
    INNER JOIN PACIENTE P     ON P.CD_PACIENTE = A.CD_PACIENTE
    INNER JOIN TIP_FRE TF ON TF.CD_TIP_FRE = IPM.CD_TIP_FRE
    LEFT JOIN UNI_PRO UP ON UP.CD_UNI_PRO = IPM.CD_UNI_PRO
    LEFT JOIN MOT_ALT MA ON MA.CD_MOT_ALT = A.CD_MOT_ALT
    LEFT JOIN TIP_RES TR ON TR.CD_TIP_RES = A.CD_TIP_RES
    JOIN ANTIBIOTICOS B
      ON INSTR(UPPER(TP.DS_TIP_PRESC), B.termo) > 0
    WHERE A.CD_MULTI_EMPRESA = 40
    --AND  A.DT_ATENDIMENTO BETWEEN '01/04/2025' AND '30/04/2025'
    AND A.DT_ATENDIMENTO >=  TO_DATE(TO_CHAR($DataIniHugo$,'DD/MM/YYYY') || ' 00:00:00', 'DD/MM/YYYY HH24:MI:SS') 
    AND A.DT_ATENDIMENTO <=  TO_DATE(TO_CHAR($DataFimHugo$,'DD/MM/YYYY') || ' 23:59:59', 'DD/MM/YYYY HH24:MI:SS')
)
SELECT *
FROM DADOS
WHERE RN = 1
 ORDER BY CD_ATENDIMENTO
 )
