WITH PRESCRICOES_UNICAS AS (
 SELECT DISTINCT
 A.CD_PACIENTE,
 CASE 
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFAZOLINA%' THEN 'CEFAZOLINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTRIAXONA%' THEN 'CEFTRIAXONA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MEROPENEM%' THEN 'MEROPENEM'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%METRONIDAZOL%' THEN 'METRONIDAZOL'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%PIPERACILINA%' THEN 'PIPERACILINA + TAZOBACTAM'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%VANCOMICINA%' AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%DOSAGEM%' THEN 'VANCOMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%POLIMIXINA%' THEN 'POLIMIXINA B'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CLINDAMICINA%' THEN 'CLINDAMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%GENTAMICINA%' THEN 'GENTAMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MUPIROCINA%' THEN 'MUPIROCINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFUROXIMA%' THEN 'CEFUROXIMA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AMICACINA%' THEN 'AMICACINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%TEICOPLANINA%' THEN 'TEICOPLANINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFALOTINA%' THEN 'CEFALOTINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%TIGECICLINA%' THEN 'TIGECICLINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%LEVOFLOXACIN%' THEN 'LEVOFLOXACINO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%LINEZOLIDA%' THEN 'LINEZOLIDA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%SULBACTAM%' THEN 'AMPICILINA + SULBACTAM'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%OXACILINA%' THEN 'OXACILINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AZITROMICINA%' THEN 'AZITROMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CLARITROMICINA%' THEN 'CLARITROMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CIPROFLOXACIN%' THEN 'CIPROFLOXACINO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%SULFAMETOXAZOL%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%TRIMETOPRIMA%' THEN 'SULFAMETOXAZOL + TRIMETOPRIMA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%SULBACTAM%' THEN 'AMPICILINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%ERTAPENEM%' THEN 'ERTAPENEM'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%IMIPENEM%' THEN 'IMIPENEM'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTAZIDIMA%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%AVIBACTAM%' THEN 'CEFTAZIDIMA + AVIBACTAM'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTAZIDIMA%' THEN 'CEFTAZIDIMA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIME%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIMA%' THEN 'CEFEPIME'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%RIFAMPICINA%' THEN 'RIFAMPICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%DOXICICLINA%' THEN 'DOXICICLINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%FOSFOMICINA%' THEN 'FOSFOMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%COLISTIN%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%COLISTIMETATO%' THEN 'COLISTINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%DAPTOMICINA%' THEN 'DAPTOMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AZTREONAM%' THEN 'AZTREONAM'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%ERITROMICINA%' THEN 'ERITROMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%TOBRAMICINA%' THEN 'TOBRAMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MOXIFLOXACIN%' THEN 'MOXIFLOXACINO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFOTAXIMA%' THEN 'CEFOTAXIMA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFALEXINA%' THEN 'CEFALEXINA'
 ELSE UPPER(TP.DS_TIP_PRESC)
 END AS ANTIMICROBIANO,
 CASE 
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MEROPENEM%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%IMIPENEM%' OR 
 UPPER(TP.DS_TIP_PRESC) LIKE '%ERTAPENEM%' THEN 'CARBAPENEMICO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%POLIMIXINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%COLISTIN%' THEN 'POLIMIXINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%VANCOMICINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%TEICOPLANINA%' THEN 'GLICOPEPTIDEO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%LINEZOLIDA%' THEN 'OXAZOLIDINONA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTAZIDIMA%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%AVIBACTAM%' THEN 'CEFALO + INIBIDOR'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFAZOLINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CEFALOTINA%' OR 
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFALEXINA%' THEN 'CEFALOSPORINA 1G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFUROXIMA%' THEN 'CEFALOSPORINA 2G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTRIAXONA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTAZIDIMA%' OR 
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFOTAXIMA%' THEN 'CEFALOSPORINA 3G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIME%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIMA%' THEN 'CEFALOSPORINA 4G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%PIPERACILINA%' OR 
 (UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%SULBACTAM%') THEN 'PENICILINA + INIBIDOR'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%PENICILINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' OR 
 UPPER(TP.DS_TIP_PRESC) LIKE '%OXACILINA%' THEN 'PENICILINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CIPROFLOXACIN%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%LEVOFLOXACIN%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%MOXIFLOXACIN%' THEN 'QUINOLONA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%GENTAMICINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%AMICACINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%TOBRAMICINA%' THEN 'AMINOGLICOSIDEO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AZITROMICINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CLARITROMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%ERITROMICINA%' THEN 'MACROLIDEO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%METRONIDAZOL%' THEN 'NITROIMIDAZOL'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%TIGECICLINA%' THEN 'GLICILCICLINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CLINDAMICINA%' THEN 'LINCOSAMIDA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%SULFAMETOXAZOL%' THEN 'SULFONAMIDA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MUPIROCINA%' THEN 'TOPICO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%DAPTOMICINA%' THEN 'LIPOPEPTIDEO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AZTREONAM%' THEN 'MONOBACTAMICO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%DOXICICLINA%' THEN 'TETRACICLINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%FOSFOMICINA%' THEN 'FOSFOMICINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%RIFAMPICINA%' THEN 'RIFAMICINA'
 ELSE 'OUTRO'
 END AS CLASSE,
 CASE 
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MEROPENEM%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%IMIPENEM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%POLIMIXINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%COLISTIN%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%TIGECICLINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%LINEZOLIDA%' OR
 (UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTAZIDIMA%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%AVIBACTAM%') OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%DAPTOMICINA%' THEN 'CRITICO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%VANCOMICINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%TEICOPLANINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%PIPERACILINA%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIME%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%LEVOFLOXACIN%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%AMICACINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AZTREONAM%' THEN 'RESTRITO'
 ELSE 'PADRAO'
 END AS CRITICIDADE
 FROM ATENDIME A
 INNER JOIN PRE_MED PM ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 INNER JOIN ITPRE_MED IT ON IT.CD_PRE_MED = PM.CD_PRE_MED
 INNER JOIN TIP_PRESC TP ON TP.CD_TIP_PRESC = IT.CD_TIP_PRESC
 WHERE A.CD_MULTI_EMPRESA = 40
 AND PM.DT_PRE_MED >= TO_DATE('01/01/2025', 'DD/MM/YYYY')
 AND PM.DT_PRE_MED < TO_DATE('01/01/2026', 'DD/MM/YYYY')
 AND IT.SN_CANCELADO = 'N'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%DOSAGEM%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%EXAME%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%GASOMETRIA%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%COLETA%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%LEVONORGESTREL%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%LEVODOPA%'
 AND (
 UPPER(TP.DS_TIP_PRESC) LIKE '%MEROPENEM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%ERTAPENEM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%IMIPENEM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%POLIMIXINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%COLISTIN%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%VANCOMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%TEICOPLANINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%LINEZOLIDA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTAZIDIMA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTRIAXONA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIME%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFAZOLINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFALOTINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFUROXIMA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%PIPERACILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CIPROFLOXACIN%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%LEVOFLOXACIN%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%GENTAMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AMICACINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AZITROMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CLARITROMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%METRONIDAZOL%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%TIGECICLINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CLINDAMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%SULFAMETOXAZOL%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%MUPIROCINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%OXACILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%PENICILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%DAPTOMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AZTREONAM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%RIFAMPICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%DOXICICLINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%FOSFOMICINA%'
 )
)
SELECT 
 ANTIMICROBIANO,
 CLASSE,
 CRITICIDADE,
 COUNT(*) AS TOTAL_PRESCRICOES_UNICAS,
 ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS PERCENTUAL
FROM PRESCRICOES_UNICAS
GROUP BY ANTIMICROBIANO, CLASSE, CRITICIDADE
ORDER BY TOTAL_PRESCRICOES_UNICAS DESC
