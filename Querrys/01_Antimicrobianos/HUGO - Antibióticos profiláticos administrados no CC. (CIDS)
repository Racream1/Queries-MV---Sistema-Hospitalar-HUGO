WITH base_cirurgia AS (
  SELECT
    ac.CD_AVISO_CIRURGIA,
    ac.CD_ATENDIMENTO,
    atd.CD_PACIENTE,
    pac.NM_PACIENTE,
    ac.DT_REALIZACAO     AS INICIO_CIRURGIA,
    ac.DT_FIM_CIRURGIA   AS DT_FIM_CIRURGIA
  FROM DBAMV.AVISO_CIRURGIA ac
  JOIN DBAMV.ATENDIME  atd ON ac.CD_ATENDIMENTO = atd.CD_ATENDIMENTO
  JOIN DBAMV.PACIENTE  pac ON atd.CD_PACIENTE   = pac.CD_PACIENTE
  WHERE ac.TP_SITUACAO        = 'R'
    AND atd.CD_MULTI_EMPRESA  = 40
    AND ac.DT_REALIZACAO BETWEEN
        TO_DATE(TO_CHAR($pgmvDataIni$,'dd/mm/yyyy')||' 00:00','dd/mm/yyyy hh24:mi')
      AND TO_DATE(TO_CHAR($pgmvDataFim$,'dd/mm/yyyy')||' 23:59','dd/mm/yyyy hh24:mi')
),
doc_911 AS (
  SELECT DISTINCT
    b.CD_AVISO_CIRURGIA,
    erc.CD_REGISTRO AS reg_911,
    TO_NUMBER(TRIM(
      dbamv.fnc_resp_doc_v2(
        b.CD_ATENDIMENTO,911,'AVISO_CIRURGIA_1',erc.CD_REGISTRO
      )
    )) AS aviso_cirurgia_1
  FROM base_cirurgia b
  JOIN DBAMV.PW_DOCUMENTO_CLINICO  pdc ON pdc.CD_ATENDIMENTO = b.CD_ATENDIMENTO
  JOIN DBAMV.PW_EDITOR_CLINICO     pec ON pec.CD_DOCUMENTO_CLINICO = pdc.CD_DOCUMENTO_CLINICO AND pec.CD_DOCUMENTO = 911
  JOIN DBAMV.EDITOR_REGISTRO_CAMPO erc ON erc.CD_REGISTRO = pec.CD_EDITOR_REGISTRO
),
doc_times AS (
  SELECT
    b.CD_AVISO_CIRURGIA,
    MAX(dbamv.fnc_resp_doc_v2(b.CD_ATENDIMENTO,911,'FC_DATA_INICIO_ANESTESIA_1',d9.reg_911)) AS fc_data_inicio_anestesia_1,
    MAX(dbamv.fnc_resp_doc_v2(b.CD_ATENDIMENTO,911,'FC_HORA_INICIO_1',d9.reg_911)) AS fc_hora_inicio_1,
    MAX(dbamv.fnc_resp_doc_v2(b.CD_ATENDIMENTO,911,'FC_MINUTO_INICIO_1',d9.reg_911)) AS fc_minuto_inicio_1
  FROM base_cirurgia b
  LEFT JOIN doc_911 d9 ON d9.CD_AVISO_CIRURGIA = b.CD_AVISO_CIRURGIA
  GROUP BY b.CD_AVISO_CIRURGIA
),
antibio_rank AS (
  SELECT
    b.CD_AVISO_CIRURGIA,
    pdc.CD_ATENDIMENTO,
    erc.CD_REGISTRO,
    ROW_NUMBER() OVER (
      PARTITION BY b.CD_AVISO_CIRURGIA
      ORDER BY
        TO_NUMBER(dbamv.fnc_resp_doc_v2(pdc.CD_ATENDIMENTO,911,'FC_HORA_ANTIB_1_1',erc.CD_REGISTRO)),
        TO_NUMBER(dbamv.fnc_resp_doc_v2(pdc.CD_ATENDIMENTO,911,'FC_MINUTO_ANTIB_1_1',erc.CD_REGISTRO)),
        erc.CD_REGISTRO
    ) AS rn
  FROM base_cirurgia b
  JOIN DBAMV.PW_DOCUMENTO_CLINICO pdc ON pdc.CD_ATENDIMENTO = b.CD_ATENDIMENTO
  JOIN DBAMV.PW_EDITOR_CLINICO pec ON pec.CD_DOCUMENTO_CLINICO = pdc.CD_DOCUMENTO_CLINICO AND pec.CD_DOCUMENTO = 911
  JOIN DBAMV.EDITOR_REGISTRO_CAMPO erc ON erc.CD_REGISTRO = pec.CD_EDITOR_REGISTRO
),
antibio_pivot AS (
  SELECT
    CD_AVISO_CIRURGIA,
    MAX(CASE WHEN rn = 1 THEN SUBSTR(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_TP_ANT_01_1_1',CD_REGISTRO),4) END) AS ANTIB_1_NOME,
    MAX(CASE WHEN rn = 1 THEN dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_DOSE_ANT_01_1',CD_REGISTRO) END) AS ANTIB_1_DOSE,
    MAX(CASE WHEN rn = 1 THEN LPAD(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_HORA_ANTIB_1_1',CD_REGISTRO),2,'0')||':'||LPAD(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_MINUTO_ANTIB_1_1',CD_REGISTRO),2,'0') END) AS ANTIB_1_HORARIO,
    MAX(CASE WHEN rn = 2 THEN SUBSTR(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_TP_ANT_02_2_1',CD_REGISTRO),4) END) AS ANTIB_2_NOME,
    MAX(CASE WHEN rn = 2 THEN dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_DOSE_ANT_02_1',CD_REGISTRO) END) AS ANTIB_2_DOSE,
    MAX(CASE WHEN rn = 2 THEN LPAD(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_HORA_ANTIB_2_1',CD_REGISTRO),2,'0')||':'||LPAD(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_MINUTO_ANTIB_2_1',CD_REGISTRO),2,'0') END) AS ANTIB_2_HORARIO,
    MAX(CASE WHEN rn = 3 THEN SUBSTR(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_TP_ANT_03_3_1',CD_REGISTRO),4) END) AS ANTIB_3_NOME,
    MAX(CASE WHEN rn = 3 THEN dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_DOSE_ANT_03_1',CD_REGISTRO) END) AS ANTIB_3_DOSE,
    MAX(CASE WHEN rn = 3 THEN LPAD(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_HORA_ANTIB_3_1',CD_REGISTRO),2,'0')||':'||LPAD(dbamv.fnc_resp_doc_v2(CD_ATENDIMENTO,911,'FC_MINUTO_ANTIB_3_1',CD_REGISTRO),2,'0') END) AS ANTIB_3_HORARIO
  FROM antibio_rank
  GROUP BY CD_AVISO_CIRURGIA
),
cirurgia_rank AS (
  SELECT
    ca.CD_AVISO_CIRURGIA,
    cc.DS_CIRURGIA,
    ROW_NUMBER() OVER (
      PARTITION BY ca.CD_AVISO_CIRURGIA
      ORDER BY cc.DS_CIRURGIA
    ) AS rn
  FROM DBAMV.CIRURGIA_AVISO ca
  JOIN DBAMV.CIRURGIA cc ON cc.CD_CIRURGIA = ca.CD_CIRURGIA
),
cirurgia_pivot AS (
  SELECT
    CD_AVISO_CIRURGIA,
    MAX(CASE WHEN rn = 1 THEN DS_CIRURGIA END) AS CIRURGIA_1,
    MAX(CASE WHEN rn = 2 THEN DS_CIRURGIA END) AS CIRURGIA_2,
    MAX(CASE WHEN rn = 3 THEN DS_CIRURGIA END) AS CIRURGIA_3
  FROM cirurgia_rank
  GROUP BY CD_AVISO_CIRURGIA
),
-- PASSO 1: A sua consulta original Ã© agora uma CTE.
resultados_finais AS (
  SELECT
    b.CD_AVISO_CIRURGIA,
    b.CD_ATENDIMENTO,
    b.CD_PACIENTE,
    b.NM_PACIENTE,
    b.INICIO_CIRURGIA,
    b.DT_FIM_CIRURGIA,
    cp.CIRURGIA_1,
    CASE WHEN cp.CIRURGIA_2 = cp.CIRURGIA_1 THEN NULL ELSE cp.CIRURGIA_2 END AS CIRURGIA_2,
    CASE WHEN cp.CIRURGIA_3 IN (cp.CIRURGIA_1, cp.CIRURGIA_2) THEN NULL ELSE cp.CIRURGIA_3 END AS CIRURGIA_3,
    TO_CHAR(
      TO_DATE(dt.fc_data_inicio_anestesia_1,'dd/mm/yyyy')
      + NUMTODSINTERVAL(TO_NUMBER(dt.fc_hora_inicio_1),'hour')
      + NUMTODSINTERVAL(TO_NUMBER(dt.fc_minuto_inicio_1),'minute'),
      'dd/mm/yyyy hh24:mi'
    ) AS INICIO_ANESTESIA,
    dbamv.fnc_resp_doc_v2(b.CD_ATENDIMENTO,911,'THR_incio_cir_911_1',d9.reg_911) AS INCISAO_CIRURGICA,
    ap.ANTIB_1_NOME,
    ap.ANTIB_1_DOSE,
    ap.ANTIB_1_HORARIO,
    ap.ANTIB_2_NOME,
    ap.ANTIB_2_DOSE,
    ap.ANTIB_2_HORARIO,
    ap.ANTIB_3_NOME,
    ap.ANTIB_3_DOSE,
    ap.ANTIB_3_HORARIO
  FROM base_cirurgia b
  LEFT JOIN doc_911        d9 ON d9.CD_AVISO_CIRURGIA = b.CD_AVISO_CIRURGIA
  LEFT JOIN doc_times      dt ON dt.CD_AVISO_CIRURGIA = b.CD_AVISO_CIRURGIA
  LEFT JOIN antibio_pivot  ap ON ap.CD_AVISO_CIRURGIA = b.CD_AVISO_CIRURGIA
  LEFT JOIN cirurgia_pivot cp ON cp.CD_AVISO_CIRURGIA = b.CD_AVISO_CIRURGIA
)
-- PASSO 2: Selecionamos a partir dos resultados, numerando as duplicadas e pegando apenas a primeira.
SELECT
  CD_AVISO_CIRURGIA,
  CD_ATENDIMENTO,
  CD_PACIENTE,
  NM_PACIENTE,
  INICIO_CIRURGIA,
  DT_FIM_CIRURGIA,
  CIRURGIA_1,
  CIRURGIA_2,
  CIRURGIA_3,
  INICIO_ANESTESIA,
  INCISAO_CIRURGICA,
  ANTIB_1_NOME,
  ANTIB_1_DOSE,
  ANTIB_1_HORARIO,
  ANTIB_2_NOME,
  ANTIB_2_DOSE,
  ANTIB_2_HORARIO,
  ANTIB_3_NOME,
  ANTIB_3_DOSE,
  ANTIB_3_HORARIO
FROM (
  SELECT
    rf.*,
    ROW_NUMBER() OVER(PARTITION BY rf.CD_AVISO_CIRURGIA ORDER BY rf.INICIO_ANESTESIA DESC NULLS LAST) as rn
  FROM resultados_finais rf
)
WHERE rn = 1
ORDER BY INICIO_CIRURGIA
