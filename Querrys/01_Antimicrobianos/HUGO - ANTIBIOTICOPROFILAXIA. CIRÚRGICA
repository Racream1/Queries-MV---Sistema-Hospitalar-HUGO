-- MONITORAMENTO DE PROFILAXIA ANTIMICROBIANA CIRURGICA
-- Hospital: Hugo (CD_MULTI_EMPRESA = 40)
-- Periodo: Ultimos 30 dias (dinamico)
-- Fonte de Dados: DBAMV - Sistema MV

SELECT 
 -- DADOS DO PACIENTE
 P.CD_PACIENTE AS COD_PACIENTE,
 P.NM_PACIENTE AS PACIENTE,
 TRUNC(MONTHS_BETWEEN(SYSDATE, P.DT_NASCIMENTO)/12) AS IDADE,
 P.TP_SEXO AS SEXO,
 
 -- DADOS DO ATENDIMENTO
 A.CD_ATENDIMENTO AS ATENDIMENTO,
 A.TP_ATENDIMENTO AS TIPO_ATEND,
 L.DS_LEITO AS LEITO,
 S.NM_SETOR AS SETOR_ATUAL,
 
 -- DADOS DA CIRURGIA
 AC.CD_AVISO_CIRURGIA AS COD_CIRURGIA,
 TO_CHAR(AC.DT_AVISO_CIRURGIA, 'DD/MM/YYYY') AS DATA_AGENDAMENTO,
 TO_CHAR(AC.DT_INICIO_CIRURGIA, 'DD/MM/YYYY HH24:MI') AS INICIO_CIRURGIA,
 TO_CHAR(AC.DT_FIM_CIRURGIA, 'DD/MM/YYYY HH24:MI') AS FIM_CIRURGIA,
 CIR.DS_CIRURGIA AS PROCEDIMENTO,
 CA.SN_ANTIMICROB_PROFILATICO AS MARCADO_PROFILAXIA,
 AC.TP_SITUACAO AS SITUACAO_CIRURGIA,
 
 -- DADOS DO ANTIMICROBIANO
 TP.DS_TIP_PRESC AS ANTIMICROBIANO,
 IT.QT_ITPRE_MED AS DOSE,
 UP.DS_UNIDADE AS UNIDADE,
 FA.DS_FOR_APL AS VIA_ADMINISTRACAO,
 
 -- DADOS DA PRESCRICAO
 TO_CHAR(PM.DT_PRE_MED, 'DD/MM/YYYY') AS DATA_PRESCRICAO,
 TO_CHAR(PM.HR_PRE_MED, 'HH24:MI') AS HORA_PRESCRICAO,
 PREST.NM_PRESTADOR AS PRESCRITOR,
 
 -- CALCULO DO TIMING (diferenca em horas)
 CASE 
 WHEN AC.DT_INICIO_CIRURGIA IS NOT NULL AND PM.DT_PRE_MED IS NOT NULL THEN
 ROUND((AC.DT_INICIO_CIRURGIA - PM.DT_PRE_MED) * 24, 1)
 ELSE NULL
 END AS DIF_HORAS_PRESC_CIRURGIA,
 
 -- AVALIACAO DO TIMING
 CASE 
 WHEN AC.DT_INICIO_CIRURGIA IS NULL THEN 'CIRURGIA NAO INICIADA'
 WHEN PM.DT_PRE_MED IS NULL THEN 'SEM PRESCRICAO'
 WHEN PM.DT_PRE_MED > AC.DT_INICIO_CIRURGIA THEN 'INADEQUADO - Prescrito apos cirurgia'
 WHEN (AC.DT_INICIO_CIRURGIA - PM.DT_PRE_MED) * 24 <= 1 THEN 'ADEQUADO - 0 a 1h antes'
 WHEN (AC.DT_INICIO_CIRURGIA - PM.DT_PRE_MED) * 24 <= 2 THEN 'ACEITAVEL - 1 a 2h antes'
 WHEN (AC.DT_INICIO_CIRURGIA - PM.DT_PRE_MED) * 24 <= 4 THEN 'LIMITROFE - 2 a 4h antes'
 WHEN (AC.DT_INICIO_CIRURGIA - PM.DT_PRE_MED) * 24 > 4 THEN 'INADEQUADO - Mais de 4h antes'
 ELSE 'VERIFICAR'
 END AS TIMING_PROFILAXIA,
 
 -- CLASSIFICACAO DO ANTIMICROBIANO
 CASE 
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFAZOLINA%' THEN 'CEFALOSPORINA 1G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFUROXIMA%' THEN 'CEFALOSPORINA 2G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTRIAXONA%' THEN 'CEFALOSPORINA 3G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIME%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIMA%' THEN 'CEFALOSPORINA 4G'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%SULBACTAM%' THEN 'PENICILINA + INIBIDOR'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' THEN 'PENICILINA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%PIPERACILINA%' THEN 'PENICILINA + INIBIDOR'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%VANCOMICINA%' THEN 'GLICOPEPTIDEO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CLINDAMICINA%' THEN 'LINCOSAMIDA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%METRONIDAZOL%' THEN 'NITROIMIDAZOL'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CIPROFLOXACIN%' THEN 'QUINOLONA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%GENTAMICINA%' THEN 'AMINOGLICOSIDEO'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MEROPENEM%' THEN 'CARBAPENEMICO'
 ELSE 'OUTRO'
 END AS CLASSE_ANTIBIOTICO,
 
 -- ADEQUACAO DA ESCOLHA DO ANTIMICROBIANO
 CASE 
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFAZOLINA%' THEN 'ADEQUADO - Padrao ouro'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFUROXIMA%' THEN 'ADEQUADO - Alternativa'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' AND UPPER(TP.DS_TIP_PRESC) LIKE '%SULBACTAM%' THEN 'ADEQUADO - Colorretal'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CLINDAMICINA%' THEN 'ADEQUADO - Alergia'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%METRONIDAZOL%' THEN 'ADEQUADO - Associacao anaerobios'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%VANCOMICINA%' THEN 'VERIFICAR - Indicacao especial MRSA'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTRIAXONA%' THEN 'INADEQUADO - Espectro amplo'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIME%' OR UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIMA%' THEN 'INADEQUADO - Nao indicado profilaxia'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%MEROPENEM%' THEN 'INADEQUADO - Carbapenemico reserva'
 WHEN UPPER(TP.DS_TIP_PRESC) LIKE '%PIPERACILINA%' THEN 'INADEQUADO - Amplo espectro'
 ELSE 'VERIFICAR - Revisar indicacao'
 END AS ADEQUACAO_ESCOLHA

FROM DBAMV.PACIENTE P
 INNER JOIN DBAMV.ATENDIME A ON A.CD_PACIENTE = P.CD_PACIENTE
 INNER JOIN DBAMV.AVISO_CIRURGIA AC ON AC.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 INNER JOIN DBAMV.CIRURGIA_AVISO CA ON CA.CD_AVISO_CIRURGIA = AC.CD_AVISO_CIRURGIA
 INNER JOIN DBAMV.CIRURGIA CIR ON CIR.CD_CIRURGIA = CA.CD_CIRURGIA
 INNER JOIN DBAMV.PRE_MED PM ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 INNER JOIN DBAMV.ITPRE_MED IT ON IT.CD_PRE_MED = PM.CD_PRE_MED
 INNER JOIN DBAMV.TIP_PRESC TP ON TP.CD_TIP_PRESC = IT.CD_TIP_PRESC
 LEFT JOIN DBAMV.LEITO L ON L.CD_LEITO = A.CD_LEITO
 LEFT JOIN DBAMV.UNID_INT UI ON UI.CD_UNID_INT = L.CD_UNID_INT
 LEFT JOIN DBAMV.SETOR S ON S.CD_SETOR = UI.CD_SETOR
 LEFT JOIN DBAMV.PRESTADOR PREST ON PREST.CD_PRESTADOR = PM.CD_PRESTADOR
 LEFT JOIN DBAMV.UNI_PRO UP ON UP.CD_UNI_PRO = IT.CD_UNI_PRO
 LEFT JOIN DBAMV.FOR_APL FA ON FA.CD_FOR_APL = IT.CD_FOR_APL
WHERE 1=1
 AND A.CD_MULTI_EMPRESA = 40
 AND AC.DT_AVISO_CIRURGIA >= SYSDATE - 30
 AND AC.DT_AVISO_CIRURGIA <= SYSDATE
 AND IT.SN_CANCELADO = 'N'
 AND TRUNC(PM.DT_PRE_MED) BETWEEN TRUNC(AC.DT_AVISO_CIRURGIA) - 1 
 AND TRUNC(AC.DT_AVISO_CIRURGIA) + 1
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%DOSAGEM%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%EXAME%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%COLETA%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%SORO%'
 AND UPPER(TP.DS_TIP_PRESC) NOT LIKE '%DIETA%'
 AND (
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFAZOLINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFUROXIMA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTRIAXONA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFOTAXIMA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFTAZIDIMA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIME%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFEPIMA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFALEXINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CEFALOTINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AMPICILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AMOXICILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%PIPERACILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%PENICILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%OXACILINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CLINDAMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%METRONIDAZOL%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%VANCOMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%GENTAMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AMICACINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CIPROFLOXACIN%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%LEVOFLOXACIN%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%MEROPENEM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%ERTAPENEM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%IMIPENEM%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%AZITROMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%CLARITROMICINA%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%SULFAMETOXAZOL%' OR
 UPPER(TP.DS_TIP_PRESC) LIKE '%TRIMETOPRIMA%'
 )
ORDER BY AC.DT_AVISO_CIRURGIA DESC, AC.DT_INICIO_CIRURGIA DESC, P.NM_PACIENTE
