-- ========================================
-- PORTLET: Absenteismo Mensal - Infectologia
-- Baseado na query de referencia validada
-- Formula: (N_ATEN / (VAGAS_OCUPADAS + ENCAIXE)) * 100
-- PERIODO: Janeiro/2025 ate hoje
-- ========================================

SELECT 
 MES_ANO,
 VAGAS_OCUPADAS AS VAGAS_OCUPADAS,
 ENCAIXE AS ENCAIXES,
 ATENDIDOS AS ATENDIDOS,
 N_ATEN AS NAO_ATENDIDOS,
 CANCELADAS AS CANCELADOS,
 ROUND(((N_ATEN * 100.0) / NULLIF((VAGAS_OCUPADAS + ENCAIXE), 0)), 2) AS TAXA_ABSENTEISMO,
 10.00 AS META_ABSENTEISMO

FROM (
 SELECT 
 TO_CHAR(DT_ANT, 'MM/YYYY') AS MES_ANO,
 TRUNC(DT_ANT, 'MM') AS MES_ORDEM,
 SUM(VAGAS_OCUPADAS) AS VAGAS_OCUPADAS,
 SUM(ENCAIXE) AS ENCAIXE,
 SUM(CANCELADAS) AS CANCELADAS,
 SUM(ATENDIDO) AS ATENDIDOS,
 SUM(N_ATEN) AS N_ATEN
 
 FROM (
 SELECT 
 CD_AGENDA_CENTRAL,
 CD_PRESTADOR,
 MIN(DT_ANT) AS DT_ANT,
 MAX(DT_REC) AS DT_REC,
 especialidade,
 SUM(ENCAIXE) AS ENCAIXE,
 SUM(VAGAS_OCUPADAS) AS VAGAS_OCUPADAS,
 SUM(CANCELADAS) AS CANCELADAS,
 SUM(ATENDIDO) AS ATENDIDO,
 SUM(N_ATEN) AS N_ATEN
 
 FROM (
 SELECT DISTINCT
 AC.CD_AGENDA_CENTRAL,
 AC.CD_PRESTADOR,
 ED.DS_ESPECIALID AS especialidade,
 AC.DT_AGENDA AS DT_ANT,
 AC.DT_AGENDA AS DT_REC,
 IT.CD_IT_AGENDA_CENTRAL,
 
 -- ENCAIXE
 CASE WHEN IT.SN_ENCAIXE = 'S' THEN 1 ELSE 0 END AS ENCAIXE,
 
 -- VAGAS OCUPADAS: nao cancelado E tem paciente
 CASE 
 WHEN IT.TP_SITUACAO = 'C' THEN 0 
 WHEN IT.NM_PACIENTE IS NOT NULL THEN 1 
 ELSE 0 
 END AS VAGAS_OCUPADAS,
 
 -- CANCELADAS
 CASE WHEN IT.TP_SITUACAO = 'C' THEN 1 ELSE 0 END AS CANCELADAS,
 
 -- ATENDIDO: nao cancelado E tipo ambulatorial E tem atendimento
 CASE 
 WHEN IT.TP_SITUACAO = 'C' THEN 0 
 WHEN A.TP_ATENDIMENTO <> 'A' THEN 0 
 WHEN IT.CD_ATENDIMENTO IS NOT NULL THEN 1 
 ELSE 0 
 END AS ATENDIDO,
 
 -- NAO ATENDIDO (Absenteismo): nao cancelado E (tipo <> A OU sem atendimento) E tem paciente
 CASE 
 WHEN IT.TP_SITUACAO = 'C' THEN 0 
 WHEN A.TP_ATENDIMENTO <> 'A' THEN 0 
 WHEN IT.NM_PACIENTE IS NULL THEN 0 
 WHEN IT.CD_ATENDIMENTO IS NULL THEN 1 
 ELSE 0 
 END AS N_ATEN
 
 FROM 
 DBAMV.IT_AGENDA_CENTRAL IT 
 INNER JOIN DBAMV.AGENDA_CENTRAL AC 
 ON AC.CD_AGENDA_CENTRAL = IT.CD_AGENDA_CENTRAL
 INNER JOIN DBAMV.PRESTADOR P 
 ON P.CD_PRESTADOR = AC.CD_PRESTADOR
 LEFT JOIN DBAMV.ESP_MED EP 
 ON P.CD_PRESTADOR = EP.CD_PRESTADOR
 INNER JOIN DBAMV.ESPECIALID ED 
 ON ED.CD_ESPECIALID = EP.CD_ESPECIALID
 LEFT JOIN DBAMV.ATENDIME A 
 ON A.CD_ATENDIMENTO = IT.CD_ATENDIMENTO
 
 WHERE 
 EP.SN_ESPECIAL_PRINCIPAL = 'S'
 AND AC.CD_MULTI_EMPRESA = 40
 AND AC.SN_ATIVO = 'S'
 -- FILTRO INFECTOLOGIA
 AND UPPER(ED.DS_ESPECIALID) LIKE '%INFECT%'
 -- PERIODO: Janeiro/2025 ate hoje
 AND AC.DT_AGENDA >= TO_DATE('01/01/2025', 'DD/MM/YYYY')
 AND AC.DT_AGENDA <= SYSDATE
 
 GROUP BY
 AC.CD_PRESTADOR,
 AC.CD_AGENDA_CENTRAL,
 AC.DT_AGENDA,
 P.NM_PRESTADOR,
 A.TP_ATENDIMENTO,
 IT.CD_ATENDIMENTO,
 ED.DS_ESPECIALID,
 IT.SN_ENCAIXE,
 IT.TP_SITUACAO,
 IT.NM_PACIENTE,
 IT.CD_IT_AGENDA_CENTRAL
 )
 
 GROUP BY
 CD_PRESTADOR,
 CD_AGENDA_CENTRAL,
 especialidade
 )
 
 GROUP BY
 TO_CHAR(DT_ANT, 'MM/YYYY'),
 TRUNC(DT_ANT, 'MM')
)

ORDER BY 
 MES_ORDEM DESC
