-- PARECERES DE INFECTOLOGIA - SEM PENDENTES DE PACIENTES COM ALTA
SELECT 
 -- IDENTIFICAÇÃO DO PACIENTE
 A.CD_ATENDIMENTO AS CodAtendimento,
 P.CD_PACIENTE AS CodPaciente,
 P.NM_PACIENTE AS NomePaciente,
 TRUNC(MONTHS_BETWEEN(SYSDATE, P.DT_NASCIMENTO)/12) AS IdadePaciente,
 P.TP_SEXO AS Sexo,
 
 -- LOCALIZAÇÃO ATUAL
 L.DS_LEITO AS LeitoAtual,
 UI.DS_UNID_INT AS UnidadeInternacao,
 S.NM_SETOR AS SetorAtual,
 
 -- DADOS DA INTERNAÇÃO
 TO_CHAR(A.HR_ATENDIMENTO, 'DD/MM/YYYY HH24:MI') AS DataInternacao,
 TO_CHAR(A.HR_ALTA, 'DD/MM/YYYY HH24:MI') AS DataAlta,
 CASE 
 WHEN A.DT_ALTA IS NOT NULL THEN 'COM ALTA'
 ELSE 'INTERNADO'
 END AS StatusInternacao,
 TRUNC(SYSDATE - A.DT_ATENDIMENTO) AS DiasInternado,
 
 -- INFORMAÇÕES DO PARECER
 PM.CD_PAR_MED AS CodigoParecer,
 ESP.DS_ESPECIALID AS EspecialidadeSolicitada,
 
 -- SOLICITAÇÃO
 PREST_SOL.NM_PRESTADOR AS MedicoSolicitante,
 ESP_SOL.DS_ESPECIALID AS EspecialidadeSolicitante,
 TO_CHAR(PM.DT_SOLICITACAO, 'DD/MM/YYYY HH24:MI') AS DataSolicitacao,
 PM.DS_SOLICITACAO AS TextoSolicitacao,
 
 -- RESPOSTA
 PREST_RESP.NM_PRESTADOR AS MedicoRespondente,
 TO_CHAR(PM.DT_PARECER, 'DD/MM/YYYY HH24:MI') AS DataResposta,
 PM.DS_PARECER AS TextoParecer,
 
 -- STATUS E TEMPOS
 PM.DS_SITUACAO AS StatusParecer,
 CASE 
 WHEN PM.DS_CANCELAMENTO IS NOT NULL THEN 'CANCELADO'
 WHEN PM.DT_PARECER IS NOT NULL THEN 'RESPONDIDO'
 WHEN PM.DS_SITUACAO = 'Solicitado' THEN 'PENDENTE'
 ELSE PM.DS_SITUACAO
 END AS SituacaoAtual,
 
 -- TEMPO DE RESPOSTA
 CASE 
 WHEN PM.DT_PARECER IS NOT NULL THEN
 TRUNC(PM.DT_PARECER - PM.DT_SOLICITACAO) || ' dias ' ||
 TRUNC(MOD((PM.DT_PARECER - PM.DT_SOLICITACAO) * 24, 24)) || 'h ' ||
 TRUNC(MOD((PM.DT_PARECER - PM.DT_SOLICITACAO) * 24 * 60, 60)) || 'min'
 WHEN PM.DS_CANCELAMENTO IS NULL THEN
 TRUNC(SYSDATE - PM.DT_SOLICITACAO) || ' dias (PENDENTE)'
 ELSE 'N/A'
 END AS TempoRespostaDetalhado,
 
 CASE 
 WHEN PM.DT_PARECER IS NOT NULL THEN
 ROUND((PM.DT_PARECER - PM.DT_SOLICITACAO) * 24, 1)
 WHEN PM.DS_CANCELAMENTO IS NULL THEN
 ROUND((SYSDATE - PM.DT_SOLICITACAO) * 24, 1)
 ELSE NULL
 END AS TempoRespostaHoras,
 
 CASE 
 WHEN PM.DT_PARECER IS NOT NULL THEN
 ROUND(PM.DT_PARECER - PM.DT_SOLICITACAO, 1)
 WHEN PM.DS_CANCELAMENTO IS NULL THEN
 ROUND(SYSDATE - PM.DT_SOLICITACAO, 1)
 ELSE NULL
 END AS TempoRespostaDias,
 
 -- INFORMAÇÕES COMPLEMENTARES
 PM.DS_CANCELAMENTO AS MotivoCancelamento,
 PM.CD_DOCUMENTO_CLINICO AS CodDocumentoClin,
 
 -- PRIORIDADE/URGÊNCIA
 CASE 
 WHEN UPPER(PM.DS_SOLICITACAO) LIKE '%URGENTE%' 
 OR UPPER(PM.DS_SOLICITACAO) LIKE '%URGÊNCIA%' THEN 'URGENTE'
 WHEN UPPER(PM.DS_SOLICITACAO) LIKE '%PRIORIT%' THEN 'PRIORITÁRIO'
 ELSE 'ROTINA'
 END AS ClassificacaoUrgencia

FROM PAR_MED PM

-- ATENDIMENTO E PACIENTE
INNER JOIN ATENDIME A ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 AND A.CD_MULTI_EMPRESA = 40
INNER JOIN PACIENTE P ON A.CD_PACIENTE = P.CD_PACIENTE

-- ESPECIALIDADE SOLICITADA (INFECTOLOGIA)
INNER JOIN ESPECIALID ESP ON PM.CD_ESPECIALID = ESP.CD_ESPECIALID
 AND UPPER(ESP.DS_ESPECIALID) LIKE '%INFECT%'

-- MÉDICO SOLICITANTE
INNER JOIN PRESTADOR PREST_SOL ON PM.CD_PRESTADOR = PREST_SOL.CD_PRESTADOR

-- ESPECIALIDADE DO SOLICITANTE
LEFT JOIN ESP_MED EM ON PREST_SOL.CD_PRESTADOR = EM.CD_PRESTADOR
 AND EM.SN_ESPECIAL_PRINCIPAL = 'S'
LEFT JOIN ESPECIALID ESP_SOL ON EM.CD_ESPECIALID = ESP_SOL.CD_ESPECIALID

-- MÉDICO RESPONDENTE
LEFT JOIN PRESTADOR PREST_RESP ON PM.CD_PRESTADOR_PARECER = PREST_RESP.CD_PRESTADOR

-- LOCALIZAÇÃO ATUAL
LEFT JOIN LEITO L ON A.CD_LEITO = L.CD_LEITO
LEFT JOIN UNID_INT UI ON L.CD_UNID_INT = UI.CD_UNID_INT
LEFT JOIN SETOR S ON UI.CD_SETOR = S.CD_SETOR

WHERE A.CD_MULTI_EMPRESA = 40
 AND PM.DT_SOLICITACAO >= TO_DATE('01/01/2025', 'DD/MM/YYYY')
 
 -- ¿ FILTRO PRINCIPAL: Remove pareceres pendentes de pacientes com alta
 AND NOT (
 PM.DT_PARECER IS NULL 
 AND PM.DS_CANCELAMENTO IS NULL 
 AND A.DT_ALTA IS NOT NULL
 )
 
ORDER BY 
 CASE 
 WHEN PM.DT_PARECER IS NULL AND PM.DS_CANCELAMENTO IS NULL THEN 1
 WHEN PM.DT_PARECER IS NOT NULL THEN 2
 ELSE 3
 END,
 PM.DT_SOLICITACAO DESC
