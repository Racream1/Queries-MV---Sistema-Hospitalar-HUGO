-- ============================================================================
-- PORTLET: PAINEL CONSOLIDADO INFECTOLOGIA - PARECERES + EVOLUÇÕES
-- Descrição: Métricas completas de pareceres e evoluções por infectologista
-- Fonte de Dados: DBAMV
-- Atualização: Dados do mês atual (1º até hoje) + mês anterior completo
-- NOVA COLUNA: TOTAL_ATIVIDADES (soma pareceres + evoluções)
-- ============================================================================

WITH INFECTOLOGISTAS AS (
 SELECT DISTINCT
 p.CD_PRESTADOR,
 p.NM_PRESTADOR,
 e.DS_ESPECIALID,
 CASE 
 WHEN UPPER(p.NM_PRESTADOR) LIKE '%MURILO FRAGA OLIVEIRA CALABRIA%' 
 THEN 'S' 
 ELSE 'N' 
 END AS SN_EXCLUIR_EVOLUCOES
 FROM DBAMV.PRESTADOR p
 INNER JOIN DBAMV.ESP_MED em 
 ON p.CD_PRESTADOR = em.CD_PRESTADOR
 AND em.SN_ESPECIAL_PRINCIPAL = 'S'
 INNER JOIN DBAMV.ESPECIALID e 
 ON em.CD_ESPECIALID = e.CD_ESPECIALID
 WHERE 1=1
 AND UPPER(e.DS_ESPECIALID) LIKE '%INFECT%'
 AND p.SN_ATUANTE IN ('S', 'N', 'R', 'P', 'E', 'C', 'O', 'D', 'Q', 'B', 'H', 'V')
),

DADOS_PARECERES AS (
 SELECT 
 PM.CD_PRESTADOR_PARECER AS CD_PRESTADOR,
 COUNT(DISTINCT CASE 
 WHEN PM.DT_PARECER >= TRUNC(SYSDATE, 'MM') 
 AND PM.DT_PARECER < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
 THEN PM.CD_PAR_MED 
 END) AS PARECERES_MES_ATUAL,
 ROUND(AVG(CASE 
 WHEN PM.DT_PARECER >= TRUNC(SYSDATE, 'MM')
 AND PM.DT_PARECER < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
 THEN (PM.DT_PARECER - PM.DT_SOLICITACAO) * 24
 END), 1) AS TEMPO_MEDIO_H_MES_ATUAL,
 COUNT(DISTINCT CASE 
 WHEN PM.DT_PARECER >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -1)
 AND PM.DT_PARECER < TRUNC(SYSDATE, 'MM')
 THEN PM.CD_PAR_MED 
 END) AS PARECERES_MES_ANTERIOR,
 ROUND(AVG(CASE 
 WHEN PM.DT_PARECER >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -1)
 AND PM.DT_PARECER < TRUNC(SYSDATE, 'MM')
 THEN (PM.DT_PARECER - PM.DT_SOLICITACAO) * 24
 END), 1) AS TEMPO_MEDIO_H_MES_ANTERIOR,
 COUNT(DISTINCT CASE 
 WHEN PM.DS_SITUACAO IN ('Solicitado', 'Em Análise')
 AND PM.DS_CANCELAMENTO IS NULL
 THEN PM.CD_PAR_MED 
 END) AS PARECERES_PENDENTES,
 MAX(PM.DT_PARECER) AS ULTIMA_DATA_PARECER,
 COUNT(DISTINCT PM.CD_ATENDIMENTO) AS ATENDIMENTOS_COM_PARECER
 FROM DBAMV.PAR_MED PM
 INNER JOIN DBAMV.ATENDIME A 
 ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 AND A.CD_MULTI_EMPRESA = 40
 WHERE 1=1
 AND PM.DS_CANCELAMENTO IS NULL
 AND (
 PM.DT_PARECER >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -1)
 OR PM.DS_SITUACAO IN ('Solicitado', 'Em Análise')
 )
 GROUP BY PM.CD_PRESTADOR_PARECER
),

DADOS_EVOLUCOES AS (
 SELECT 
 PM.CD_PRESTADOR,
 COUNT(DISTINCT PM.CD_PRE_MED) AS TOTAL_EVOLUCOES,
 COUNT(DISTINCT CASE 
 WHEN PDC.TP_STATUS = 'FECHADO' 
 THEN PM.CD_PRE_MED 
 END) AS EVOLUCOES_FECHADAS,
 COUNT(DISTINCT CASE 
 WHEN PDC.TP_STATUS = 'ABERTO' 
 THEN PM.CD_PRE_MED 
 END) AS EVOLUCOES_ABERTO,
 COUNT(DISTINCT ATD.CD_ATENDIMENTO) AS PACIENTES_ATENDIDOS,
 COUNT(DISTINCT PAC.CD_PACIENTE) AS PACIENTES_UNICOS,
 ROUND(
 COUNT(DISTINCT PM.CD_PRE_MED) / 
 NULLIF(COUNT(DISTINCT TRUNC(PM.DT_PRE_MED)), 0),
 2
 ) AS MEDIA_EVOLUCOES_DIA,
 MAX(PM.DT_PRE_MED) AS ULTIMA_DATA_EVOLUCAO,
 COUNT(DISTINCT TRUNC(PM.DT_PRE_MED)) AS DIAS_TRABALHADOS
 FROM DBAMV.PRE_MED PM
 INNER JOIN DBAMV.ATENDIME ATD 
 ON PM.CD_ATENDIMENTO = ATD.CD_ATENDIMENTO
 AND ATD.CD_MULTI_EMPRESA = 40
 AND ATD.TP_ATENDIMENTO = 'I'
 INNER JOIN DBAMV.PACIENTE PAC 
 ON ATD.CD_PACIENTE = PAC.CD_PACIENTE
 LEFT JOIN DBAMV.PW_DOCUMENTO_CLINICO PDC 
 ON PM.CD_DOCUMENTO_CLINICO = PDC.CD_DOCUMENTO_CLINICO
 AND (PDC.TP_STATUS IS NULL OR PDC.TP_STATUS <> 'CANCELADO')
 WHERE 1=1
 AND PM.CD_OBJETO = 203
 AND TRUNC(PM.DT_PRE_MED) >= TRUNC(SYSDATE, 'MM')
 AND TRUNC(PM.DT_PRE_MED) <= TRUNC(SYSDATE)
 GROUP BY PM.CD_PRESTADOR
)

SELECT 
 -- === BLOCO 1: IDENTIFICAÇÃO ===
 INF.CD_PRESTADOR AS CODIGO_MEDICO,
 INF.NM_PRESTADOR AS INFECTOLOGISTA,
 INF.DS_ESPECIALID AS ESPECIALIDADE,
 
 -- === BLOCO 2: TOTALIZADOR GERAL (NOVA COLUNA) ===
 (COALESCE(PAR.PARECERES_MES_ATUAL, 0) + 
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.TOTAL_EVOLUCOES, 0)
 END) AS TOTAL_ATIVIDADES,
 
 -- === BLOCO 3: PARECERES - MÊS ATUAL ===
 COALESCE(PAR.PARECERES_MES_ATUAL, 0) AS PARECERES_MES_ATUAL,
 COALESCE(PAR.TEMPO_MEDIO_H_MES_ATUAL, 0) AS TEMPO_MEDIO_H_ATUAL,
 
 -- === BLOCO 4: PARECERES - MÊS ANTERIOR ===
 COALESCE(PAR.PARECERES_MES_ANTERIOR, 0) AS PARECERES_MES_ANTERIOR,
 COALESCE(PAR.TEMPO_MEDIO_H_MES_ANTERIOR, 0) AS TEMPO_MEDIO_H_ANTERIOR,
 
 -- === BLOCO 5: PARECERES - PENDÊNCIAS ===
 COALESCE(PAR.PARECERES_PENDENTES, 0) AS PARECERES_PENDENTES,
 
 -- === BLOCO 6: EVOLUÇÕES - MÊS ATUAL ===
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.TOTAL_EVOLUCOES, 0)
 END AS TOTAL_EVOLUCOES,
 
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.EVOLUCOES_FECHADAS, 0)
 END AS EVOLUCOES_FECHADAS,
 
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.EVOLUCOES_ABERTO, 0)
 END AS EVOLUCOES_ABERTO,
 
 -- === BLOCO 7: PACIENTES (EVOLUÇÕES) ===
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.PACIENTES_ATENDIDOS, 0)
 END AS PACIENTES_ATENDIDOS,
 
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.PACIENTES_UNICOS, 0)
 END AS PACIENTES_UNICOS,
 
 -- === BLOCO 8: PRODUTIVIDADE ===
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.MEDIA_EVOLUCOES_DIA, 0)
 END AS MEDIA_EVOLUCOES_DIA,
 
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0
 ELSE COALESCE(EVO.DIAS_TRABALHADOS, 0)
 END AS DIAS_TRABALHADOS,
 
 -- === BLOCO 9: DATAS E STATUS ===
 TO_CHAR(PAR.ULTIMA_DATA_PARECER, 'DD/MM/YYYY') AS ULTIMO_PARECER,
 
 CASE 
 WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN NULL
 ELSE TO_CHAR(EVO.ULTIMA_DATA_EVOLUCAO, 'DD/MM/YYYY')
 END AS ULTIMA_EVOLUCAO,
 
 TO_CHAR(TRUNC(SYSDATE, 'MM'), 'MM/YYYY') AS MES_REFERENCIA,
 
 CASE 
 WHEN (COALESCE(PAR.PARECERES_MES_ATUAL, 0) + 
 CASE WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0 
 ELSE COALESCE(EVO.TOTAL_EVOLUCOES, 0) 
 END) > 0 
 THEN 'Ativo'
 ELSE 'Sem Atividade'
 END AS STATUS_ATIVIDADE

FROM INFECTOLOGISTAS INF

LEFT JOIN DADOS_PARECERES PAR 
 ON INF.CD_PRESTADOR = PAR.CD_PRESTADOR

LEFT JOIN DADOS_EVOLUCOES EVO 
 ON INF.CD_PRESTADOR = EVO.CD_PRESTADOR

WHERE 1=1
 AND (
 PAR.PARECERES_MES_ATUAL > 0
 OR PAR.PARECERES_MES_ANTERIOR > 0
 OR PAR.PARECERES_PENDENTES > 0
 OR (EVO.TOTAL_EVOLUCOES > 0 AND INF.SN_EXCLUIR_EVOLUCOES = 'N')
 )

ORDER BY 
 -- Ordena pela nova coluna TOTAL_ATIVIDADES (soma)
 (COALESCE(PAR.PARECERES_MES_ATUAL, 0) + 
 CASE WHEN INF.SN_EXCLUIR_EVOLUCOES = 'S' THEN 0 
 ELSE COALESCE(EVO.TOTAL_EVOLUCOES, 0) 
 END) DESC,
 INF.NM_PRESTADOR
