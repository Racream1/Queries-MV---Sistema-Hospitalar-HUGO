SELECT 
 ESP_SOL.DS_ESPECIALID AS ESPECIALIDADE_SOLICITANTE,
 COUNT(DISTINCT PM.CD_PAR_MED) AS TOTAL_PARECERES,
 COUNT(DISTINCT CASE 
 WHEN PM.DS_SITUACAO IN ('Solicitado', 'Em AnÃ¡lise')
 AND NVL(PM.DS_CANCELAMENTO, 'N') = 'N'
 THEN PM.CD_PAR_MED 
 END) AS PARECERES_PENDENTES,
 COUNT(DISTINCT CASE 
 WHEN PM.DS_SITUACAO = 'Realizado'
 THEN PM.CD_PAR_MED 
 END) AS PARECERES_REALIZADOS,
 ROUND(AVG(CASE 
 WHEN PM.DT_PARECER IS NOT NULL
 THEN (PM.DT_PARECER - PM.DT_SOLICITACAO)
 END), 1) AS TEMPO_MEDIO_RESPOSTA_DIAS,
 ROUND(COUNT(DISTINCT PM.CD_PAR_MED) * 100.0 / 
 SUM(COUNT(DISTINCT PM.CD_PAR_MED)) OVER (), 2) AS PERCENTUAL_TOTAL,
 ESP_SOL.CD_ESPECIALID AS CODIGO_ESPECIALIDADE
FROM PAR_MED PM
INNER JOIN ATENDIME A ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
INNER JOIN PRESTADOR PREST_SOL ON PM.CD_PRESTADOR = PREST_SOL.CD_PRESTADOR
INNER JOIN ESP_MED EM_SOL ON PREST_SOL.CD_PRESTADOR = EM_SOL.CD_PRESTADOR
INNER JOIN ESPECIALID ESP_SOL ON EM_SOL.CD_ESPECIALID = ESP_SOL.CD_ESPECIALID
INNER JOIN ESPECIALID ESP_SOLICITADA ON PM.CD_ESPECIALID = ESP_SOLICITADA.CD_ESPECIALID
WHERE A.CD_MULTI_EMPRESA = 40
 AND EM_SOL.SN_ESPECIAL_PRINCIPAL = 'S'
 AND UPPER(ESP_SOLICITADA.DS_ESPECIALID) LIKE '%INFECT%'
 AND NVL(PM.DS_CANCELAMENTO, 'N') = 'N'
 AND PM.DT_SOLICITACAO >= TRUNC(SYSDATE, 'YYYY')
GROUP BY ESP_SOL.DS_ESPECIALID, ESP_SOL.CD_ESPECIALID
ORDER BY TOTAL_PARECERES DESC
