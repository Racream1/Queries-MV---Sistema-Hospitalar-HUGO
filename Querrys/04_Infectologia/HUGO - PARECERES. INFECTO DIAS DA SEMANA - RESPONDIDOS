-- PORTLET: Analise Completa Pareceres Infectologia (Com FDS)
-- Descricao: Estatisticas com media corrigida incluindo todos os dias

SELECT 
 TRIM(TO_CHAR(PM.DT_PARECER, 'D')) AS NUMDIA,
 
 CASE TRIM(TO_CHAR(PM.DT_PARECER, 'D'))
 WHEN '1' THEN 'DOMINGO'
 WHEN '2' THEN 'SEGUNDA-FEIRA'
 WHEN '3' THEN 'TERCA-FEIRA'
 WHEN '4' THEN 'QUARTA-FEIRA'
 WHEN '5' THEN 'QUINTA-FEIRA'
 WHEN '6' THEN 'SEXTA-FEIRA'
 WHEN '7' THEN 'SABADO'
 END AS DIASEMANA,
 
 COUNT(PM.CD_PAR_MED) AS TOTALRESPONDIDOS,
 
 COUNT(DISTINCT TRUNC(PM.DT_PARECER)) AS DIASCOMRESPOSTA,
 
 -- Total de dias daquele tipo no periodo
 (
 SELECT COUNT(*)
 FROM (
 SELECT TRUNC(TO_DATE('01/01/2025', 'DD/MM/YYYY') + LEVEL - 1) AS DIA
 FROM DUAL
 CONNECT BY LEVEL <= (TO_DATE('01/01/2026', 'DD/MM/YYYY') - TO_DATE('01/01/2025', 'DD/MM/YYYY'))
 )
 WHERE TRIM(TO_CHAR(DIA, 'D')) = TRIM(TO_CHAR(PM.DT_PARECER, 'D'))
 ) AS TOTALDIASNOPERIO,
 
 -- MEDIA REAL: sobre todos os dias do periodo
 ROUND(
 CAST(COUNT(PM.CD_PAR_MED) AS NUMBER) / 
 CAST((
 SELECT COUNT(*)
 FROM (
 SELECT TRUNC(TO_DATE('01/01/2025', 'DD/MM/YYYY') + LEVEL - 1) AS DIA
 FROM DUAL
 CONNECT BY LEVEL <= (TO_DATE('01/01/2026', 'DD/MM/YYYY') - TO_DATE('01/01/2025', 'DD/MM/YYYY'))
 )
 WHERE TRIM(TO_CHAR(DIA, 'D')) = TRIM(TO_CHAR(PM.DT_PARECER, 'D'))
 ) AS NUMBER), 
 2
 ) AS MEDIAREALPORDIA,
 
 -- Media quando ha atendimento
 ROUND(
 CAST(COUNT(PM.CD_PAR_MED) AS NUMBER) / 
 CAST(NULLIF(COUNT(DISTINCT TRUNC(PM.DT_PARECER)), 0) AS NUMBER), 
 2
 ) AS MEDIAQUANDOATENDE,
 
 -- Percentual de dias com atendimento
 ROUND(
 CAST(COUNT(DISTINCT TRUNC(PM.DT_PARECER)) AS NUMBER) * 100.0 /
 CAST((
 SELECT COUNT(*)
 FROM (
 SELECT TRUNC(TO_DATE('01/01/2025', 'DD/MM/YYYY') + LEVEL - 1) AS DIA
 FROM DUAL
 CONNECT BY LEVEL <= (TO_DATE('01/01/2026', 'DD/MM/YYYY') - TO_DATE('01/01/2025', 'DD/MM/YYYY'))
 )
 WHERE TRIM(TO_CHAR(DIA, 'D')) = TRIM(TO_CHAR(PM.DT_PARECER, 'D'))
 ) AS NUMBER),
 2
 ) AS PERCENTDIAATEND,
 
 ROUND(
 CAST(COUNT(PM.CD_PAR_MED) AS NUMBER) * 100.0 / 
 CAST(SUM(COUNT(PM.CD_PAR_MED)) OVER () AS NUMBER), 
 2
 ) AS PERCENTUALTOTAL,
 
 ROUND(AVG(CAST(PM.DT_PARECER - PM.DT_SOLICITACAO AS NUMBER)), 1) AS TMPRESPOSTA,
 
 COUNT(DISTINCT A.CD_PACIENTE) AS TOTALPACIENTES,
 
 COUNT(DISTINCT PM.CD_PRESTADOR) AS QTDSOLICITANTES,
 
 ROUND(MIN(CAST(PM.DT_PARECER - PM.DT_SOLICITACAO AS NUMBER)), 1) AS MENORTEMPO,
 
 ROUND(MAX(CAST(PM.DT_PARECER - PM.DT_SOLICITACAO AS NUMBER)), 1) AS MAIORTEMPO

FROM DBAMV.PAR_MED PM
INNER JOIN DBAMV.ATENDIME A ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
INNER JOIN DBAMV.ESPECIALID ESP ON PM.CD_ESPECIALID = ESP.CD_ESPECIALID

WHERE A.CD_MULTI_EMPRESA = 40
 AND UPPER(ESP.DS_ESPECIALID) LIKE '%INFECT%'
 AND PM.DS_SITUACAO = 'Realizado'
 AND PM.DS_CANCELAMENTO IS NULL
 AND PM.DT_PARECER IS NOT NULL
 AND PM.DT_PARECER >= TO_DATE('01/01/2025', 'DD/MM/YYYY')
 AND PM.DT_PARECER < TO_DATE('01/01/2026', 'DD/MM/YYYY')

GROUP BY 
 TRIM(TO_CHAR(PM.DT_PARECER, 'D')),
 CASE TRIM(TO_CHAR(PM.DT_PARECER, 'D'))
 WHEN '1' THEN 'DOMINGO'
 WHEN '2' THEN 'SEGUNDA-FEIRA'
 WHEN '3' THEN 'TERCA-FEIRA'
 WHEN '4' THEN 'QUARTA-FEIRA'
 WHEN '5' THEN 'QUINTA-FEIRA'
 WHEN '6' THEN 'SEXTA-FEIRA'
 WHEN '7' THEN 'SABADO'
 END

ORDER BY TRIM(TO_CHAR(PM.DT_PARECER, 'D'))
