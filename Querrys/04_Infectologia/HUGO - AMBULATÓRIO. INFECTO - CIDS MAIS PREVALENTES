-- ========================================
-- PORTLET: Principais Diagnósticos - Infectologia
-- Objetivo: CIDs mais frequentes com detalhamento
-- ========================================

SELECT
 C.CD_CID AS CODIGO_CID,
 C.DS_CID AS DIAGNOSTICO,
 COUNT(DISTINCT A.CD_PACIENTE) AS PACIENTES_UNICOS,
 COUNT(A.CD_ATENDIMENTO) AS TOTAL_CONSULTAS,
 ROUND((COUNT(A.CD_ATENDIMENTO) * 100.0 / 
 SUM(COUNT(A.CD_ATENDIMENTO)) OVER ()), 2) AS PERCENTUAL_TOTAL,
 
 -- Média de consultas por paciente com este diagnóstico
 ROUND(COUNT(A.CD_ATENDIMENTO) / COUNT(DISTINCT A.CD_PACIENTE), 1) AS MEDIA_CONSULTAS_PACIENTE

FROM DBAMV.ATENDIME A
 INNER JOIN DBAMV.CID C ON A.CD_CID = C.CD_CID
 INNER JOIN DBAMV.ESPECIALID E ON A.CD_ESPECIALID = E.CD_ESPECIALID

WHERE A.CD_MULTI_EMPRESA = 40
 AND A.TP_ATENDIMENTO = 'A'
 AND UPPER(E.DS_ESPECIALID) LIKE '%INFECTO%'
 AND A.HR_ATENDIMENTO >= TO_DATE('01/01/2025 00:00', 'DD/MM/YYYY HH24:MI')
 AND A.CD_CID IS NOT NULL

GROUP BY C.CD_CID, C.DS_CID

ORDER BY COUNT(A.CD_ATENDIMENTO) DESC

-- Limitar aos 20 principais
FETCH FIRST 20 ROWS ONLY
