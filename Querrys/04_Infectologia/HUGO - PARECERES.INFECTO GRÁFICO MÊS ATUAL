SELECT 
 PREST.NM_PRESTADOR AS Infectologista,
 
 -- MÊS ATUAL
 COUNT(DISTINCT CASE 
 WHEN PM.DT_PARECER >= TRUNC(SYSDATE, 'MM') 
 AND PM.DT_PARECER < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
 THEN PM.CD_PAR_MED 
 END) AS PareceresMesAtual,
 
 ROUND(AVG(CASE 
 WHEN PM.DT_PARECER >= TRUNC(SYSDATE, 'MM')
 AND PM.DT_PARECER < ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
 THEN (PM.DT_PARECER - PM.DT_SOLICITACAO) * 24
 END), 1) AS TempoMedioHorasMesAtual,
 
 -- MÊS ANTERIOR
 COUNT(DISTINCT CASE 
 WHEN PM.DT_PARECER >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -1)
 AND PM.DT_PARECER < TRUNC(SYSDATE, 'MM')
 THEN PM.CD_PAR_MED 
 END) AS PareceresMesAnterior,
 
 ROUND(AVG(CASE 
 WHEN PM.DT_PARECER >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -1)
 AND PM.DT_PARECER < TRUNC(SYSDATE, 'MM')
 THEN (PM.DT_PARECER - PM.DT_SOLICITACAO) * 24
 END), 1) AS TempoMedioHorasMesAnterior,
 
 -- PENDENTES
 COUNT(DISTINCT CASE 
 WHEN PM.DS_SITUACAO IN ('Solicitado', 'Em Análise')
 AND PM.DS_CANCELAMENTO IS NULL
 THEN PM.CD_PAR_MED 
 END) AS PareceresPendentes,
 
 PREST.CD_PRESTADOR AS CodigoMedico
 
FROM PAR_MED PM
INNER JOIN PRESTADOR PREST ON PM.CD_PRESTADOR_PARECER = PREST.CD_PRESTADOR
INNER JOIN ESP_MED EM ON PREST.CD_PRESTADOR = EM.CD_PRESTADOR
INNER JOIN ESPECIALID ESP ON EM.CD_ESPECIALID = ESP.CD_ESPECIALID
INNER JOIN ATENDIME A ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
WHERE A.CD_MULTI_EMPRESA = 40
 AND EM.SN_ESPECIAL_PRINCIPAL = 'S'
 AND UPPER(ESP.DS_ESPECIALID) LIKE '%INFECT%'
 AND PM.DS_CANCELAMENTO IS NULL
 AND (
 PM.DT_PARECER >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -1)
 OR PM.DS_SITUACAO IN ('Solicitado', 'Em Análise')
 )
GROUP BY PREST.NM_PRESTADOR, PREST.CD_PRESTADOR
HAVING COUNT(DISTINCT PM.CD_PAR_MED) > 0
ORDER BY PareceresMesAtual DESC
