-- ============================================================
-- PORTLET: Pareceres e Evoluções de Infectologistas
-- Versão corrigida com aliases válidos para sistema MV
-- Período: Últimos 3 meses
-- ============================================================

WITH PARECERES_BASE AS (
 SELECT 
 PM.CD_PRESTADOR_PARECER,
 COUNT(DISTINCT PM.CD_PAR_MED) AS TOTAL_PARECERES,
 ROUND(COUNT(DISTINCT PM.CD_PAR_MED) / 3, 2) AS MEDIA_PARECERES_MES,
 ROUND(AVG(PM.DT_PARECER - PM.DT_SOLICITACAO) * 24, 1) AS TEMPO_MEDIO_HORAS,
 ROUND(AVG(PM.DT_PARECER - PM.DT_SOLICITACAO), 1) AS TEMPO_MEDIO_DIAS,
 COUNT(DISTINCT CASE 
 WHEN PM.DS_SITUACAO IN ('Solicitado', 'Em Análise')
 AND NVL(PM.DS_CANCELAMENTO, 'N') = 'N'
 THEN PM.CD_PAR_MED 
 END) AS PARECERES_PENDENTES
 FROM DBAMV.PAR_MED PM
 INNER JOIN DBAMV.ATENDIME A ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 WHERE A.CD_MULTI_EMPRESA = 40
 AND NVL(PM.DS_CANCELAMENTO, 'N') = 'N'
 AND (
 (PM.DT_PARECER >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -3)
 AND PM.DT_PARECER IS NOT NULL)
 OR PM.DS_SITUACAO IN ('Solicitado', 'Em Análise')
 )
 GROUP BY PM.CD_PRESTADOR_PARECER
),
EVOLUCOES_BASE AS (
 SELECT 
 PRE.CD_PRESTADOR,
 COUNT(DISTINCT PRE.CD_PRE_MED) AS TOTAL_EVOLUCOES
 FROM DBAMV.PRE_MED PRE
 INNER JOIN DBAMV.ATENDIME A ON PRE.CD_ATENDIMENTO = A.CD_ATENDIMENTO
 LEFT JOIN DBAMV.PW_DOCUMENTO_CLINICO PW ON PW.CD_DOCUMENTO_CLINICO = PRE.CD_DOCUMENTO_CLINICO
 WHERE A.CD_MULTI_EMPRESA = 40
 AND PRE.CD_OBJETO = 203
 AND PRE.DT_PRE_MED >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -3)
 AND NVL(PW.TP_STATUS, 'FECHADO') NOT IN ('CANCELADO', 'ABERTO')
 GROUP BY PRE.CD_PRESTADOR
)
SELECT 
 PREST.NM_PRESTADOR AS INFECTOLOGISTA,
 PREST.CD_PRESTADOR AS CODIGO_MEDICO,
 NVL(PB.TOTAL_PARECERES, 0) AS TOTAL_PARECERES_3M,
 NVL(PB.MEDIA_PARECERES_MES, 0) AS MEDIA_PARECERES_MES,
 NVL(PB.TEMPO_MEDIO_HORAS, 0) AS TEMPO_MEDIO_HORAS,
 NVL(PB.TEMPO_MEDIO_DIAS, 0) AS TEMPO_MEDIO_DIAS,
 NVL(PB.PARECERES_PENDENTES, 0) AS PARECERES_PENDENTES,
 NVL(EB.TOTAL_EVOLUCOES, 0) AS TOTAL_EVOLUCOES_3M,
 ROUND(NVL(EB.TOTAL_EVOLUCOES, 0) / 3, 2) AS MEDIA_EVOLUCOES_MES,
 (NVL(PB.TOTAL_PARECERES, 0) + NVL(EB.TOTAL_EVOLUCOES, 0)) AS TOTAL_AVALIACOES_3M,
 ROUND((NVL(PB.TOTAL_PARECERES, 0) + NVL(EB.TOTAL_EVOLUCOES, 0)) / 3, 2) AS MEDIA_TOTAL_AVALIACOES_MES
FROM DBAMV.PRESTADOR PREST
INNER JOIN DBAMV.ESP_MED EM ON PREST.CD_PRESTADOR = EM.CD_PRESTADOR
INNER JOIN DBAMV.ESPECIALID ESP ON EM.CD_ESPECIALID = ESP.CD_ESPECIALID
LEFT JOIN PARECERES_BASE PB ON PREST.CD_PRESTADOR = PB.CD_PRESTADOR_PARECER
LEFT JOIN EVOLUCOES_BASE EB ON PREST.CD_PRESTADOR = EB.CD_PRESTADOR
WHERE EM.SN_ESPECIAL_PRINCIPAL = 'S'
 AND UPPER(ESP.DS_ESPECIALID) LIKE '%INFECT%'
 AND (NVL(PB.TOTAL_PARECERES, 0) > 0 OR NVL(EB.TOTAL_EVOLUCOES, 0) > 0)
ORDER BY 
 (NVL(PB.TOTAL_PARECERES, 0) + NVL(EB.TOTAL_EVOLUCOES, 0)) DESC,
 NVL(PB.MEDIA_PARECERES_MES, 0) DESC
