SELECT 
 PREST_SOL.NM_PRESTADOR AS MEDICO_SOLICITANTE,
 ESP_SOL.DS_ESPECIALID AS ESPECIALIDADE,
 COUNT(DISTINCT PM.CD_PAR_MED) AS TOTAL_PARECERES,
 COUNT(DISTINCT CASE 
 WHEN PM.DS_SITUACAO IN ('Solicitado', 'Em AnÃ¡lise')
 AND NVL(PM.DS_CANCELAMENTO, 'N') = 'N'
 THEN PM.CD_PAR_MED 
 END) AS PENDENTES,
 COUNT(DISTINCT CASE 
 WHEN PM.DS_SITUACAO = 'Realizado'
 THEN PM.CD_PAR_MED 
 END) AS REALIZADOS,
 ROUND(AVG(CASE 
 WHEN PM.DT_PARECER IS NOT NULL
 THEN (PM.DT_PARECER - PM.DT_SOLICITACAO)
 END), 1) AS TEMPO_MEDIO_DIAS,
 MIN(PM.DT_SOLICITACAO) AS PRIMEIRA_SOLICITACAO,
 MAX(PM.DT_SOLICITACAO) AS ULTIMA_SOLICITACAO,
 PREST_SOL.CD_PRESTADOR AS CODIGO_PRESTADOR
FROM PAR_MED PM
INNER JOIN ATENDIME A ON PM.CD_ATENDIMENTO = A.CD_ATENDIMENTO
INNER JOIN PRESTADOR PREST_SOL ON PM.CD_PRESTADOR = PREST_SOL.CD_PRESTADOR
INNER JOIN ESP_MED EM_SOL ON PREST_SOL.CD_PRESTADOR = EM_SOL.CD_PRESTADOR
INNER JOIN ESPECIALID ESP_SOL ON EM_SOL.CD_ESPECIALID = ESP_SOL.CD_ESPECIALID
INNER JOIN ESPECIALID ESP_SOLICITADA ON PM.CD_ESPECIALID = ESP_SOLICITADA.CD_ESPECIALID
WHERE A.CD_MULTI_EMPRESA = 40
 AND EM_SOL.SN_ESPECIAL_PRINCIPAL = 'S'
 AND UPPER(ESP_SOLICITADA.DS_ESPECIALID) LIKE '%INFECT%'
 AND NVL(PM.DS_CANCELAMENTO, 'N') = 'N'
 AND PM.DT_SOLICITACAO >= TRUNC(SYSDATE, 'YYYY')
GROUP BY PREST_SOL.NM_PRESTADOR, ESP_SOL.DS_ESPECIALID, PREST_SOL.CD_PRESTADOR
HAVING COUNT(DISTINCT PM.CD_PAR_MED) >= 3
ORDER BY TOTAL_PARECERES DESC
