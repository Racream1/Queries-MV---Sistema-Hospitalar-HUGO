 SELECT 
CASE WHEN ME.CD_MODALIDADE_EXAME = 3 AND DS_EXA_RX LIKE '%US DOPPLER%' THEN 'ULTRASSONOGRAFIA/DOPPLER'
 WHEN ME.CD_MODALIDADE_EXAME = 3 AND DS_EXA_RX LIKE '%ECOCARDIOGRAMA%' THEN 'ECOCARDIOGRAMA'
 WHEN ME.CD_MODALIDADE_EXAME = 3 AND DS_EXA_RX LIKE '%BRONCO%' THEN 'BRONCOSCOPIA'
 WHEN ME.CD_MODALIDADE_EXAME = 9 AND EXA_RX.CD_EXA_RX IN (1152) THEN 'COLONOSCOPIA - ENDOSCOPIA DIGESTIVA BAIXO'
 ELSE ME.DS_MODALIDADE_EXAME END EXAME, COUNT(*) AS QTD
 
 FROM DBAMV.PED_RX
 INNER JOIN SETOR S ON S.CD_SETOR = PED_RX.CD_SETOR 
 INNER JOIN DBAMV.ITPED_RX ON PED_RX.CD_PED_RX = ITPED_RX.CD_PED_RX
 INNER JOIN DBAMV.ATENDIME ON PED_RX.CD_ATENDIMENTO = ATENDIME.CD_ATENDIMENTO
 INNER JOIN DBAMV.EXA_RX ON ITPED_RX.CD_EXA_RX = EXA_RX.CD_EXA_RX
 INNER JOIN SET_EXA ON PED_RX.CD_SET_EXA = SET_EXA.CD_SET_EXA 
 INNER JOIN MODALIDADE_EXAME ME ON ME.CD_MODALIDADE_EXAME = EXA_RX.CD_MODALIDADE_EXAME

 WHERE 
1=1
AND ATENDIME.CD_MULTI_EMPRESA = 40
AND (
 (ME.CD_MODALIDADE_EXAME = 10 AND ITPED_RX.SN_REALIZADO IN ('S','N'))
 OR
 (ME.CD_MODALIDADE_EXAME <> 10 AND ITPED_RX.SN_REALIZADO = 'S')
 )
 
 AND (
 (ME.CD_MODALIDADE_EXAME = 10 AND PED_RX.DT_PEDIDO BETWEEN To_Date(Concat(To_Char(To_Date('01/07/2025','dd/mm/yyyy'),'dd/mm/yyyy'), '00:00'), 'dd/mm/yyyy hh24:mi') 
AND To_Date(Concat(To_Char(To_Date('31/07/2025','dd/mm/yyyy'),'dd/mm/yyyy'), '23:59'), 'dd/mm/yyyy hh24:mi'))
 OR
 (ME.CD_MODALIDADE_EXAME <> 10 AND TRUNC(ITPED_RX.DT_REALIZADO) BETWEEN To_Date(Concat(To_Char(To_Date('01/07/2025','dd/mm/yyyy'),'dd/mm/yyyy'), '00:00'), 'dd/mm/yyyy hh24:mi') 
AND To_Date(Concat(To_Char(To_Date('31/07/2025','dd/mm/yyyy'),'dd/mm/yyyy'), '23:59'), 'dd/mm/yyyy hh24:mi'))
 )
AND TP_ATENDIMENTO IN ('A','E')

GROUP BY CASE WHEN ME.CD_MODALIDADE_EXAME = 3 AND DS_EXA_RX LIKE '%US DOPPLER%' THEN 'ULTRASSONOGRAFIA/DOPPLER'
 WHEN ME.CD_MODALIDADE_EXAME = 3 AND DS_EXA_RX LIKE '%ECOCARDIOGRAMA%' THEN 'ECOCARDIOGRAMA'
 WHEN ME.CD_MODALIDADE_EXAME = 3 AND DS_EXA_RX LIKE '%BRONCO%' THEN 'BRONCOSCOPIA'
 WHEN ME.CD_MODALIDADE_EXAME = 9 AND EXA_RX.CD_EXA_RX IN (1152) THEN 'COLONOSCOPIA - ENDOSCOPIA DIGESTIVA BAIXO'
 ELSE ME.DS_MODALIDADE_EXAME END
ORDER BY EXAME
