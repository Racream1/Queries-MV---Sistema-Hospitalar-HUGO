WITH params AS (
    SELECT
        TO_DATE(TO_CHAR($pgmvDataIni$,'dd/mm/yyyy')||' 00:00','dd/mm/yyyy hh24:mi') AS data_inicio,
        TO_DATE(TO_CHAR($pgmvDataFim$,'dd/mm/yyyy')||' 23:59','dd/mm/yyyy hh24:mi') AS data_fim,
        40 AS cd_unidade
    FROM DUAL
),

ATENDIMENTOS_COM_ALTA AS (
    SELECT 
        a.CD_ATENDIMENTO,
        a.CD_PACIENTE,
        a.HR_ATENDIMENTO AS DATA_HORA_CHEGADA,
        a.HR_ALTA AS DATA_HORA_ALTA,
        TO_CHAR(a.HR_ATENDIMENTO, 'YYYY-MM') AS MES_REFERENCIA,
        TO_CHAR(a.HR_ATENDIMENTO, 'MM/YYYY') AS MES_FORMATO,
        ROUND((a.HR_ALTA - a.HR_ATENDIMENTO) * 24 * 60, 2) AS TEMPO_PERMANENCIA_MINUTOS,
        ROUND((a.HR_ALTA - a.HR_ATENDIMENTO) * 24, 2) AS TEMPO_PERMANENCIA_HORAS
    FROM DBAMV.ATENDIME a
    INNER JOIN params p ON a.HR_ATENDIMENTO BETWEEN p.data_inicio AND p.data_fim
    WHERE a.TP_ATENDIMENTO = 'U'
      AND a.HR_ALTA IS NOT NULL
      AND a.CD_MULTI_EMPRESA = p.cd_unidade
)

SELECT
    MES_FORMATO AS MES,
    COUNT(*) AS TOTAL_ATENDIMENTOS_COM_ALTA,
    ROUND(AVG(TEMPO_PERMANENCIA_MINUTOS), 2) AS TEMPO_MEDIO_PERMANENCIA_MINUTOS,
    ROUND(AVG(TEMPO_PERMANENCIA_HORAS), 2) AS TEMPO_MEDIO_PERMANENCIA_HORAS,
    TRUNC(AVG(TEMPO_PERMANENCIA_HORAS)) || 'h ' || 
    LPAD(ROUND(MOD(AVG(TEMPO_PERMANENCIA_MINUTOS), 60)), 2, '0') || 'min' AS TEMPO_MEDIO_FORMATO_LEGIVEL,
    ROUND(MIN(TEMPO_PERMANENCIA_HORAS), 2) AS TEMPO_MINIMO_HORAS,
    ROUND(MAX(TEMPO_PERMANENCIA_HORAS), 2) AS TEMPO_MAXIMO_HORAS,
    ROUND(MEDIAN(TEMPO_PERMANENCIA_HORAS), 2) AS TEMPO_MEDIANA_HORAS
FROM ATENDIMENTOS_COM_ALTA
GROUP BY MES_REFERENCIA, MES_FORMATO
ORDER BY MES_REFERENCIA
