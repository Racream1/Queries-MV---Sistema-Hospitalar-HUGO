-- Parte 1: Período e Listas Base
WITH params AS (
    SELECT TO_DATE('01/02/2025', 'DD/MM/YYYY') AS dh_inicio, TO_DATE('30/09/2025 23:59:59', 'DD/MM/YYYY HH24:MI:SS') AS dh_fim FROM DUAL
),
urgencias_periodo AS (
    SELECT
        A.CD_ATENDIMENTO, A.CD_PACIENTE,
        (TRUNC(A.DT_ATENDIMENTO) + (A.HR_ATENDIMENTO - TRUNC(A.HR_ATENDIMENTO))) AS HR_ATENDIMENTO_CORRIGIDO,
        CASE WHEN A.DT_ALTA IS NOT NULL THEN (TRUNC(A.DT_ALTA) + (A.HR_ALTA - TRUNC(A.HR_ALTA))) ELSE NULL END AS HR_ALTA_CORRIGIDO,
        COALESCE(SC.DS_TIPO_RISCO, 'Sem Classificação') AS DS_TIPO_RISCO,
        classif_inicio.dh_processo AS DH_INICIO_TRIAGEM
    FROM DBAMV.ATENDIME A
    CROSS JOIN params p
    LEFT JOIN DBAMV.TRIAGEM_ATENDIMENTO STA ON A.CD_ATENDIMENTO = STA.CD_ATENDIMENTO
    LEFT JOIN DBAMV.SACR_CLASSIFICACAO SC ON STA.CD_CLASSIFICACAO = SC.CD_CLASSIFICACAO
    LEFT JOIN (SELECT cd_triagem_atendimento, MIN(dh_processo) AS dh_processo FROM DBAMV.SACR_TEMPO_PROCESSO WHERE cd_tipo_tempo_processo = 11 GROUP BY cd_triagem_atendimento) classif_inicio
               ON classif_inicio.cd_triagem_atendimento = STA.cd_triagem_atendimento
    WHERE A.TP_ATENDIMENTO = 'U' AND A.CD_MULTI_EMPRESA = 40 AND A.DT_ATENDimento BETWEEN p.DH_INICIO AND p.DH_FIM
),
internacoes_periodo AS (
    SELECT A.CD_ATENDIMENTO, A.CD_PACIENTE, (TRUNC(A.DT_ATENDIMENTO) + (A.HR_ATENDIMENTO - TRUNC(A.HR_ATENDIMENTO))) AS HR_ATENDIMENTO_CORRIGIDO,
           CASE WHEN A.DT_ALTA IS NOT NULL THEN (TRUNC(A.DT_ALTA) + (A.HR_ALTA - TRUNC(A.HR_ALTA))) ELSE NULL END AS HR_ALTA_CORRIGIDO
    FROM DBAMV.ATENDIME A CROSS JOIN params p
    WHERE A.TP_ATENDIMENTO = 'I' AND A.CD_MULTI_EMPRESA = 40 AND A.DT_ATENDIMENTO BETWEEN p.DH_INICIO AND p.DH_FIM
),
-- Parte 2: PONTO DE CHEGADA - Lógica para encontrar a saída física da emergência
movimento_saida_emergencia AS (
    SELECT
        m.cd_atendimento,
        MIN((TRUNC(m.DT_MOV_INT) + (m.HR_MOV_INT - TRUNC(m.HR_MOV_INT)))) AS DH_SAIDA_EMERGENCIA
    FROM DBAMV.MOV_INT m
    INNER JOIN DBAMV.LEITO l_origem ON m.cd_leito_anterior = l_origem.cd_leito
    INNER JOIN DBAMV.LEITO l_destino ON m.cd_leito = l_destino.cd_leito
    WHERE
        l_origem.cd_unid_int IN (601, 561, 559, 560) -- Leito de ORIGEM é Emergência
        AND l_destino.cd_unid_int NOT IN (601, 561, 559, 560) -- Leito de DESTINO NÃO é Emergência
    GROUP BY m.cd_atendimento
),
-- Parte 3: Lógica do "Par Perfeito"
pares_perfeitos AS (
    SELECT CD_PACIENTE, ATENDIMENTO_URGENCIA, DH_INICIO_TRIAGEM, DATA_HORA_ENTRADA_URGENCIA, DATA_HORA_ALTA_URGENCIA, CLASSIFICACAO_RISCO,
           ATENDIMENTO_INTERNACAO, DATA_HORA_ENTRADA_INTERNACAO, DATA_HORA_ALTA_HOSPITALAR
    FROM (
        SELECT p.*,
               ROW_NUMBER() OVER(PARTITION BY ATENDIMENTO_URGENCIA ORDER BY DATA_HORA_ENTRADA_INTERNACAO ASC) as rank_urg_para_int,
               ROW_NUMBER() OVER(PARTITION BY ATENDIMENTO_INTERNACAO ORDER BY DATA_HORA_ENTRADA_URGENCIA DESC) as rank_int_para_urg
        FROM (
            SELECT U.CD_PACIENTE, U.CD_ATENDIMENTO AS ATENDIMENTO_URGENCIA, U.DH_INICIO_TRIAGEM, U.HR_ATENDIMENTO_CORRIGIDO AS DATA_HORA_ENTRADA_URGENCIA, U.HR_ALTA_CORRIGIDO AS DATA_HORA_ALTA_URGENCIA, U.DS_TIPO_RISCO AS CLASSIFICACAO_RISCO,
                   I.CD_ATENDIMENTO AS ATENDIMENTO_INTERNACAO, I.HR_ATENDIMENTO_CORRIGIDO AS DATA_HORA_ENTRADA_INTERNACAO, I.HR_ALTA_CORRIGIDO AS DATA_HORA_ALTA_HOSPITALAR
            FROM urgencias_periodo U JOIN internacoes_periodo I ON U.CD_PACIENTE = I.CD_PACIENTE
                AND I.HR_ATENDIMENTO_CORRIGIDO > U.HR_ATENDIMENTO_CORRIGIDO
                AND I.HR_ATENDIMENTO_CORRIGIDO <= U.HR_ATENDIMENTO_CORRIGIDO + 2
        ) p
    )
    WHERE rank_urg_para_int = 1 AND rank_int_para_urg = 1
)

-- Consulta Final: Unindo todos os cenários com TODAS as colunas
-- 1. Os Pares Perfeitos
SELECT
    pp.CD_PACIENTE,
    'URGÊNCIA <-> INTERNAÇÃO' AS TIPO_REGISTRO,
    pp.ATENDIMENTO_URGENCIA,
    pp.DATA_HORA_ENTRADA_URGENCIA,
    pp.DATA_HORA_ALTA_URGENCIA,
    pp.CLASSIFICACAO_RISCO,
    pp.ATENDIMENTO_INTERNACAO,
    pp.DATA_HORA_ENTRADA_INTERNACAO,
    pp.DATA_HORA_ALTA_HOSPITALAR,
    mse.DH_SAIDA_EMERGENCIA,
    -- A Métrica Final Solicitada
    ROUND((mse.DH_SAIDA_EMERGENCIA - pp.DH_INICIO_TRIAGEM) * 24, 2) AS TEMPO_TRIAGEM_ATE_LEITO_H,
    pp.DATA_HORA_ENTRADA_URGENCIA AS DATA_ORDENACAO
FROM pares_perfeitos pp
-- Busca pelo ATENDIMENTO_INTERNACAO, conforme instruído
LEFT JOIN movimento_saida_emergencia mse ON pp.ATENDIMENTO_INTERNACAO = mse.cd_atendimento

UNION ALL

-- 2. As Urgências "Órfãs"
SELECT
    U.CD_PACIENTE,
    'URGÊNCIA (S/ INTERNAÇÃO)' AS TIPO_REGISTRO,
    U.CD_ATENDIMENTO,
    U.HR_ATENDIMENTO_CORRIGIDO,
    U.HR_ALTA_CORRIGIDO,
    U.DS_TIPO_RISCO,
    NULL, NULL, NULL, -- Colunas da Internação
    NULL, NULL, -- Novas colunas da métrica
    U.HR_ATENDIMENTO_CORRIGIDO
FROM urgencias_periodo U
WHERE U.CD_ATENDIMENTO NOT IN (SELECT ATENDIMENTO_URGENCIA FROM pares_perfeitos)

UNION ALL

-- 3. As Internações "Órfãs"
SELECT
    I.CD_PACIENTE,
    'INTERNAÇÃO (DIRETA)' AS TIPO_REGISTRO,
    NULL, NULL, NULL, NULL, -- Colunas da Urgência
    I.CD_ATENDIMENTO,
    I.HR_ATENDIMENTO_CORRIGIDO,
    I.HR_ALTA_CORRIGIDO,
    NULL, NULL, -- Novas colunas da métrica
    I.HR_ATENDIMENTO_CORRIGIDO
FROM internacoes_periodo I
WHERE I.CD_ATENDIMENTO NOT IN (SELECT ATENDIMENTO_INTERNACAO FROM pares_perfeitos)

ORDER BY 1, 12
